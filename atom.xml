<?xml version="1.0" encoding="utf-8"?>
<feed xmlns="http://www.w3.org/2005/Atom">
  <title>TeeMo</title>
  
  
  <link href="/atom.xml" rel="self"/>
  
  <link href="http://yoursite.com/"/>
  <updated>2019-05-10T16:37:45.953Z</updated>
  <id>http://yoursite.com/</id>
  
  <author>
    <name>TeeMo</name>
    
  </author>
  
  <generator uri="http://hexo.io/">Hexo</generator>
  
  <entry>
    <title>OSPF-报文格式：</title>
    <link href="http://yoursite.com/2019/05/11/hcip%E7%AC%94%E8%AE%B0ospf/"/>
    <id>http://yoursite.com/2019/05/11/hcip笔记ospf/</id>
    <published>2019-05-10T16:26:13.000Z</published>
    <updated>2019-05-10T16:37:45.953Z</updated>
    
    <content type="html"><![CDATA[<h1 id="OSPF报文格式"><a href="#OSPF报文格式" class="headerlink" title="OSPF报文格式"></a>OSPF报文格式</h1><h3 id="OSPF报文可靠性机制："><a href="#OSPF报文可靠性机制：" class="headerlink" title="OSPF报文可靠性机制："></a>OSPF报文可靠性机制：</h3><ul><li>由于OSPF协议时通过IP承载的，而IP协议时不可靠协议，所以OSPF需要自己的可靠机制来保证报文交互的可靠性</li><li>在OSPF中有两种确认报文：1，显式确认报文（LSack）2，隐式确认报文（Hello/DBD/LSU）</li></ul><h3 id="OSPF-报文头部："><a href="#OSPF-报文头部：" class="headerlink" title="OSPF 报文头部："></a>OSPF 报文头部：</h3><hr><p><img src="/2019/05/11/hcip笔记ospf/ospf.JPG" alt="ospf"></p><table><thead><tr><th style="text-align:center">报文格式重要字段</th><th style="text-align:center">长度（字节）</th><th style="text-align:center">作用</th></tr></thead><tbody><tr><td style="text-align:center">version</td><td style="text-align:center">8</td><td style="text-align:center">版本</td></tr><tr><td style="text-align:center">type</td><td style="text-align:center">8</td><td style="text-align:center">OSPF报文类型：1为Hello，2为DD，3为LSR，4为LSU，5为LSACK</td></tr><tr><td style="text-align:center">packet length</td><td style="text-align:center">16</td><td style="text-align:center">OSPF报文总长度</td></tr><tr><td style="text-align:center">router-id</td><td style="text-align:center">32</td><td style="text-align:center">自己的R-ID</td></tr><tr><td style="text-align:center">area-id</td><td style="text-align:center">32</td><td style="text-align:center">区域id</td></tr><tr><td style="text-align:center">checksum</td><td style="text-align:center">16</td><td style="text-align:center">除认证字段的校验和</td></tr><tr><td style="text-align:center">autype</td><td style="text-align:center">16</td><td style="text-align:center">认证字段：0为不认证，1为简单明文，2为MD5</td></tr><tr><td style="text-align:center">authentication</td><td style="text-align:center">64</td><td style="text-align:center">验证信息：0没有，1为明文密码，2为key id</td></tr></tbody></table><h3 id="Hello报文"><a href="#Hello报文" class="headerlink" title="Hello报文:"></a>Hello报文:</h3><hr><p><img src="/2019/05/11/hcip笔记ospf/hello.jpg" alt="hello"></p><table><thead><tr><th style="text-align:center">报文格式重要字段</th><th style="text-align:center">长度（字节）</th><th style="text-align:center">作用</th></tr></thead><tbody><tr><td style="text-align:center">network</td><td style="text-align:center">32</td><td style="text-align:center">发送hello报文的接口所在的子网掩码</td></tr><tr><td style="text-align:center">Hellointerval</td><td style="text-align:center">16</td><td style="text-align:center">hello时间</td></tr><tr><td style="text-align:center">Options</td><td style="text-align:center">8</td><td style="text-align:center">标识发送此报文的OSPF路由器所支持的可选功能。</td></tr><tr><td style="text-align:center">Rtr Pri</td><td style="text-align:center">8</td><td style="text-align:center">DR优先级</td></tr><tr><td style="text-align:center">RouterDeadlnterval</td><td style="text-align:center">32</td><td style="text-align:center">dead时间</td></tr><tr><td style="text-align:center">Designated Router</td><td style="text-align:center">32</td><td style="text-align:center">DR接口ip地址</td></tr><tr><td style="text-align:center">Backup designated Router</td><td style="text-align:center">32</td><td style="text-align:center">BDR的接口ip地址</td></tr><tr><td style="text-align:center">Neighbor</td><td style="text-align:center">32</td><td style="text-align:center">所有邻居的R-ID</td></tr></tbody></table><ul><li>通过查看Hello报文option字段中E的置位，判断该区域是否支持外部LSA(LSA),可以判断该区域是否为stub区域。</li></ul><h3 id="OPTIONS字段："><a href="#OPTIONS字段：" class="headerlink" title="OPTIONS字段："></a>OPTIONS字段：</h3><hr><p><img src="/2019/05/11/hcip笔记ospf/op.JPG" alt="op"></p><p> Option可选字段出现在每一个Hello数据包、DD和每个LSA中的。 </p><p> Option字段允许路由器和其他路由器进行一些可选性能的通信。 </p><h3 id="DD报文"><a href="#DD报文" class="headerlink" title="DD报文:"></a>DD报文:</h3><hr><p><img src="/2019/05/11/hcip笔记ospf/dd.jpg" alt="dd"></p><table><thead><tr><th style="text-align:center">报文格式重要字段</th><th style="text-align:center">长度（字节）</th><th style="text-align:center">作用</th></tr></thead><tbody><tr><td style="text-align:center">Interface MTU</td><td style="text-align:center">16</td><td style="text-align:center">不分片的情况下，此接口最大可发出的ip报文长度</td></tr><tr><td style="text-align:center">Options</td><td style="text-align:center">16</td><td style="text-align:center">标识发送此报文的OSPF路由器所支持的可选功能。</td></tr><tr><td style="text-align:center">I 位</td><td style="text-align:center">1</td><td style="text-align:center">当置位为1时，表明这是第一个DD报文，否则不置位</td></tr><tr><td style="text-align:center">M 位</td><td style="text-align:center">1</td><td style="text-align:center">置位为1的时候表明DD报文中还有LSA头要传递，否则不置位</td></tr><tr><td style="text-align:center">M/S 位</td><td style="text-align:center">1</td><td style="text-align:center">置位为1表示自己为master，否则不置位</td></tr><tr><td style="text-align:center">DD Sequence Number</td><td style="text-align:center">32</td><td style="text-align:center">序列号，主从双方利用序列号来保证报文传输的可靠性和完整性</td></tr><tr><td style="text-align:center">LSA headers</td><td style="text-align:center">-</td><td style="text-align:center">本LSDB的LSA头</td></tr></tbody></table><h3 id="LSA-格式"><a href="#LSA-格式" class="headerlink" title="LSA 格式:"></a>LSA 格式:</h3><hr><p><img src="/2019/05/11/hcip笔记ospf/lsa.JPG" alt="lsa"></p><table><thead><tr><th style="text-align:center">报文格式重要字段</th><th style="text-align:center">长度（比特）</th><th style="text-align:center">作用</th></tr></thead><tbody><tr><td style="text-align:center">LS Age</td><td style="text-align:center">16</td><td style="text-align:center">LSA的生存时间</td></tr><tr><td style="text-align:center">Options</td><td style="text-align:center">16</td><td style="text-align:center">标识发送此报文的OSPF路由器所支持的可选功能。</td></tr><tr><td style="text-align:center">LS type</td><td style="text-align:center">8</td><td style="text-align:center">LSA类型</td></tr><tr><td style="text-align:center">Link state ID</td><td style="text-align:center">32</td><td style="text-align:center">链路状态ID,每一个LSA都有不同的描述</td></tr><tr><td style="text-align:center">Advertising router</td><td style="text-align:center">32</td><td style="text-align:center">产生该LSA的R-ID</td></tr><tr><td style="text-align:center">LS Sequence Number</td><td style="text-align:center">32</td><td style="text-align:center">LSA序列号，越大代表该LSA越新，每产生一条，seq+1</td></tr><tr><td style="text-align:center">LS checksum</td><td style="text-align:center">16</td><td style="text-align:center">用于校验LSA的内容及用来确定该LSA是否最新。</td></tr><tr><td style="text-align:center">Lenght</td><td style="text-align:center">16</td><td style="text-align:center">LSA的总长度</td></tr></tbody></table><ul><li>路由器如何识别两个LSA是同一个：<ul><li>LSA类型</li><li>link start id</li><li>Advertising router</li><li>以上参数唯一标识一条LSA.</li></ul></li><li>路由器怎么判断LSA的新旧：<ol><li>LS Sequence Number<ul><li>序列号越大代表越新，</li></ul></li><li>LS checksum<ul><li>序列号相同，校验值越大代表越新</li></ul></li><li>LS Age<ul><li>校验值相同，比较age，如果老化时间为3600，则选择该LSA,如果老化时间相差15min以内，说明相同，可以任意选择，如果老化时间大约15min，则选择老化时间小的。</li></ul></li></ol></li></ul><h3 id="不同类型LSA中Link-State-id字段的作用："><a href="#不同类型LSA中Link-State-id字段的作用：" class="headerlink" title="不同类型LSA中Link State id字段的作用："></a>不同类型LSA中Link State id字段的作用：</h3><table><thead><tr><th style="text-align:center">LSA类型</th><th style="text-align:center">Link State id 的作用</th></tr></thead><tbody><tr><td style="text-align:center">Router-LSA</td><td style="text-align:center">生成这条LSA路由器的R-ID</td></tr><tr><td style="text-align:center">Network-LSA</td><td style="text-align:center">所描述网络上DR接口的IP地址</td></tr><tr><td style="text-align:center">Network-summary-LSA</td><td style="text-align:center">所描述的目的网段地址</td></tr><tr><td style="text-align:center">ABR Network-summary-LSA</td><td style="text-align:center">所描述ASBR路由器的R-ID</td></tr><tr><td style="text-align:center">AS-External LSA</td><td style="text-align:center">所描述的AS外部网段地址</td></tr></tbody></table><h3 id="Router-LSA中有三个flag位："><a href="#Router-LSA中有三个flag位：" class="headerlink" title="Router-LSA中有三个flag位："></a>Router-LSA中有三个flag位：</h3><ol><li>V(Virtual link): 置1标识本地配置了vlink，为0标识不存在。</li><li>E（ASBR）：置1标识本地是ASBR，为0不是ASBR。</li><li>B（ABR）：置1标识本地是ABR，为0不是ABR。</li></ol>]]></content>
    
    <summary type="html">
    
      
      
        &lt;h1 id=&quot;OSPF报文格式&quot;&gt;&lt;a href=&quot;#OSPF报文格式&quot; class=&quot;headerlink&quot; title=&quot;OSPF报文格式&quot;&gt;&lt;/a&gt;OSPF报文格式&lt;/h1&gt;&lt;h3 id=&quot;OSPF报文可靠性机制：&quot;&gt;&lt;a href=&quot;#OSPF报文可靠性机制：&quot; cla
      
    
    </summary>
    
      <category term="HCIP-R&amp;S 笔记" scheme="http://yoursite.com/categories/HCIP-R-S-%E7%AC%94%E8%AE%B0/"/>
    
    
      <category term="HCIP" scheme="http://yoursite.com/tags/HCIP/"/>
    
      <category term="OSPF" scheme="http://yoursite.com/tags/OSPF/"/>
    
  </entry>
  
  <entry>
    <title>OSPF-路由协议基础：</title>
    <link href="http://yoursite.com/2019/05/10/hcip%E7%AC%94%E8%AE%B0/"/>
    <id>http://yoursite.com/2019/05/10/hcip笔记/</id>
    <published>2019-05-10T15:32:51.000Z</published>
    <updated>2019-05-10T16:25:54.701Z</updated>
    
    <content type="html"><![CDATA[<h1 id="OSPF-路由协议基础："><a href="#OSPF-路由协议基础：" class="headerlink" title="OSPF 路由协议基础："></a>OSPF 路由协议基础：</h1><h3 id="OSPF概述："><a href="#OSPF概述：" class="headerlink" title="OSPF概述："></a>OSPF概述：</h3><hr><ul><li>OSPF（开放式最短路径优先）</li><li>基于链路状态信息的内部网关协议（IGP协议）</li><li><p>基于IP协议，协议号：89</p></li><li><p>SPF算法：OSPF区域中所有的路由器会从与他相邻的路由器获得LSA,将这些LSA存入LSDB中，计算到每一地方的最优路径，然后将最优路径存入全局路由表中。在计算的过程中，就已经消除了环路</p></li></ul><h3 id="OSPF特点："><a href="#OSPF特点：" class="headerlink" title="OSPF特点："></a>OSPF特点：</h3><hr><ol><li><p>使用区域化的概念：区域内部独立计算，减少对内存和cpu的占用。构建了一个层次化的网络拓扑。</p></li><li><p>支持无类路由，支持划分子网。</p></li><li><p>没有开销限制，</p></li><li><p>局部更新</p></li><li><p>支持负载分担（最多8条）</p></li><li><p>使用组播更新报文（DR:224.0.0.6,其他路由器：224.0.0.5）</p></li><li><p>支持md5认证</p></li></ol><h3 id="OSPF区域："><a href="#OSPF区域：" class="headerlink" title="OSPF区域："></a>OSPF区域：</h3><hr><ul><li><p>分为骨干区域和非骨干区域</p></li><li><p>每个网络拓扑里面只允许存在一个骨干区域，所有的非骨干区域必须与骨干区域相连。</p></li></ul><h3 id="OSPF网络类型"><a href="#OSPF网络类型" class="headerlink" title="OSPF网络类型"></a>OSPF网络类型</h3><hr><table><thead><tr><th style="text-align:center">网络类型</th><th style="text-align:center">Hello时间</th><th style="text-align:center">Dead时间</th><th style="text-align:left">邻居与邻接关系</th></tr></thead><tbody><tr><td style="text-align:center">广播</td><td style="text-align:center">10s</td><td style="text-align:center">40s</td><td style="text-align:left">自动建立邻居，选举DR/BDR</td></tr><tr><td style="text-align:center">P2P</td><td style="text-align:center">10s</td><td style="text-align:center">40s</td><td style="text-align:left">自动建立邻居，无需选举DR/BDR</td></tr><tr><td style="text-align:center">P2MP</td><td style="text-align:center">30s</td><td style="text-align:center">120s</td><td style="text-align:left">手动指邻居，无需选举DR/BDR</td></tr><tr><td style="text-align:center">NBMA</td><td style="text-align:center">30s</td><td style="text-align:center">120s</td><td style="text-align:left">手动指邻居，选举DR/BDR</td></tr></tbody></table><h3 id="OSPF-报文类型："><a href="#OSPF-报文类型：" class="headerlink" title="OSPF 报文类型："></a>OSPF 报文类型：</h3><table><thead><tr><th style="text-align:center">报文类型</th><th style="text-align:center">报文作用</th></tr></thead><tbody><tr><td style="text-align:center">Hello</td><td style="text-align:center">周期性的发送，用来发现，建立，维护邻居关系。</td></tr><tr><td style="text-align:center">DD-First DBD</td><td style="text-align:center">用来确定主从关系的</td></tr><tr><td style="text-align:center">DD-DBD</td><td style="text-align:center">用来描述本地链路数据库的摘要信息</td></tr><tr><td style="text-align:center">LSR</td><td style="text-align:center">用于向邻居请求所需LSA的详细信息。</td></tr><tr><td style="text-align:center">LSU</td><td style="text-align:center">用与向对方回复所请求LSA的详细信息</td></tr><tr><td style="text-align:center">LSACK</td><td style="text-align:center">用于对收到的LSA的详细信息做确认</td></tr></tbody></table><p>注：DBD报文需要做确认，哪怕master设备发送的DBD报文是空的，slave也需要做确认，否则5s重传一次。</p><p>通过keepalive机制，检测邻居的建立状态。</p><h3 id="OSPF状态机："><a href="#OSPF状态机：" class="headerlink" title="OSPF状态机："></a>OSPF状态机：</h3><table><thead><tr><th style="text-align:center">状态</th><th style="text-align:center">效果</th></tr></thead><tbody><tr><td style="text-align:center">DOWN（无效状态）</td><td style="text-align:center">表示在dead时间内没有收到hello报文</td></tr><tr><td style="text-align:center">init（初始状态）</td><td style="text-align:center">收到hello报文，没有发现自己的R-id</td></tr><tr><td style="text-align:center">2-way（双向通信状态）</td><td style="text-align:center">接受到了hello报文，且在active neighbor字段看懂了自己的R-ID</td></tr><tr><td style="text-align:center">exstart（信息交互初始状态）</td><td style="text-align:center">交互first DBD报文，确定主从关系，R-ID大的为master</td></tr><tr><td style="text-align:center">exchange（信息交换状态）</td><td style="text-align:center">交互DBD报文，携带LSA的头部信息</td></tr><tr><td style="text-align:center">loading（信息加载状态）</td><td style="text-align:center">当收到本地DBD报文中M位为0是，进入该状态</td></tr><tr><td style="text-align:center">full（完全邻接状态）</td><td style="text-align:center">路由器之间建立完全邻接状态，LSDB同步完成</td></tr></tbody></table><p><strong>注意点：</strong></p><p>2-way：当进入到2-way状态后，表明邻居关系建立完成，如果在MA的网络中，还需要选举DR/BDR.</p><p>1DR/BDR的选举过程：</p><ol><li>先比较接口优先级，华为默认为1，当为0时不参与选举。</li><li>接口优先级一致时，比较R-ID，R-ID大的为DR</li><li>DR/BDR不具有抢占性。</li></ol><p>exstart：当DBD报文中，I 位为时</p><p>，表明这是第一个DBD报文，为first-DBD报文，确定主从关系是为了方便进行lsdb的同步，确定完主从关系后，slave需要做确认，确认自己知道了谁是master，</p><p>exchage：master路由器向slave路由器发送LSDB摘要信息，并规定其实序列号，每发送一个DBD报文序列号+1，slave路由器则使使用master路由器的序列号进行应答。</p><p>loading：LSR-LSU-LSACK报文的运用，LSDB的同步过程。</p><p>attempt：该状态只有在NBMA网络类型中才有，表示本地路由器在dead时间超时后，没有收到邻居回复的hello报文，而此时路由器仍然会向对方发送hello报文。</p><h3 id="OSPF影响建立邻居关系的因素"><a href="#OSPF影响建立邻居关系的因素" class="headerlink" title="OSPF影响建立邻居关系的因素"></a>OSPF影响建立邻居关系的因素</h3><ul><li>R-ID一致：1.直连设备（邻居关系无法建立）2.同区域不直连（可以建立邻居,LSDB不能同步），3.不同区域不直连（不影响邻居关系的建立，   ）</li><li>area-id不一致</li><li>area类型不一致</li><li>hello/dead时间不一致</li><li>认证参数及密钥不一致</li><li>掩码不一致==（只针对于MA网络）==</li><li>接口被静默</li></ul><h3 id="OSPF影响邻接关系建立的因素："><a href="#OSPF影响邻接关系建立的因素：" class="headerlink" title="OSPF影响邻接关系建立的因素："></a>OSPF影响邻接关系建立的因素：</h3><ul><li>MTU(华为默认填充字段为0)</li><li>DR优先级为（只针对于MA网络）</li><li>链路状态请求列表（LSR）或链路重传列表（LSU）不为空</li></ul><h3 id="DR-BDR的概念："><a href="#DR-BDR的概念：" class="headerlink" title="DR/BDR的概念："></a>DR/BDR的概念：</h3><ul><li><p>为什么要有DR/BDR:</p><blockquote><p>选举DR的目的是为了避免在广播网络和非广播网络中LSA的重复通告而带来的带宽浪费问题</p><p>选举DR也可以减少邻居关系关系的建立，避免发送大量的hello包来占用带宽</p><p>选举BDR是为了做DR的备份。</p></blockquote></li><li><p>为什么DR没有抢占机制：</p><blockquote><p>因为DR区域内的路由器没有建立全连接的邻接关系，所以如果进行抢占的话，会DRother会与新的DR建立邻接关系，</p></blockquote></li><li><p>DR/BDR何时可以抢占：</p><blockquote><p>当新加入的设备发送的Hello报文中，DR/BDR字段不为空，即可以发生强占，若为空的话，DR/BDR会之间把自己的地址进行填充。</p></blockquote></li><li><p>DR/BDR的选举流程：</p><blockquote><p> 先选BDR,在BDR的集合里选举DR，BDR成为了DR后，再从优先级非0的集合中选举BDR.</p></blockquote></li></ul>]]></content>
    
    <summary type="html">
    
      
      
        &lt;h1 id=&quot;OSPF-路由协议基础：&quot;&gt;&lt;a href=&quot;#OSPF-路由协议基础：&quot; class=&quot;headerlink&quot; title=&quot;OSPF 路由协议基础：&quot;&gt;&lt;/a&gt;OSPF 路由协议基础：&lt;/h1&gt;&lt;h3 id=&quot;OSPF概述：&quot;&gt;&lt;a href=&quot;#OSPF概述
      
    
    </summary>
    
      <category term="HCIP-R&amp;S 笔记" scheme="http://yoursite.com/categories/HCIP-R-S-%E7%AC%94%E8%AE%B0/"/>
    
    
      <category term="HCIP" scheme="http://yoursite.com/tags/HCIP/"/>
    
      <category term="OSPF" scheme="http://yoursite.com/tags/OSPF/"/>
    
  </entry>
  
  <entry>
    <title>HCIP综合实验</title>
    <link href="http://yoursite.com/2019/05/10/HCIP%E7%BB%BC%E5%90%88%E5%AE%9E%E9%AA%8C/"/>
    <id>http://yoursite.com/2019/05/10/HCIP综合实验/</id>
    <published>2019-05-10T04:12:57.000Z</published>
    <updated>2019-05-10T15:33:18.467Z</updated>
    
    <content type="html"><![CDATA[<h1 id="HCIP综合实验："><a href="#HCIP综合实验：" class="headerlink" title="HCIP综合实验："></a>HCIP综合实验：</h1><h3 id="实验拓扑："><a href="#实验拓扑：" class="headerlink" title="实验拓扑："></a>实验拓扑：</h3><p><img src="/2019/05/10/HCIP综合实验/hcip.png" alt="hcip"></p><h3 id="拓扑描述："><a href="#拓扑描述：" class="headerlink" title="拓扑描述："></a>拓扑描述：</h3><hr><ul><li>网络规划如图所示：</li><li>AS 100内运行MPLS VPN,</li><li>各具体实验要求如下所示</li></ul><h3 id="实验要求："><a href="#实验要求：" class="headerlink" title="实验要求："></a>实验要求：</h3><hr><ul><li><p>全网依照拓扑图配置vlan和IP地址</p></li><li><p>总公司：</p><ol><li><p>SW3和SW4的互连接口启用eth-trunk，最大带宽为2G</p></li><li><p>SW1、SW2、SW3、和SW4运行MSTP，SW1为VLAN10的Root，SW2为VLAN20的Root</p></li><li><p>PC1-PC4需要提供网关冗余，为了提高安全性，需要做认证，并使用BFD动态检查上行链路状态，实现自动切换</p></li></ol></li><li><p>AS100需求：</p><ol><li><p>每台设备都需要配置Loopback接口，地址为X.X.X.X（X为设备编号）</p></li><li><p>AS100底层IGP协议为IS-IS，区域为level-2，确保各路由器的loopback接口互通</p></li><li><p>R1与R4建立IBGP邻居（使用loopback接口）</p></li></ol></li><li><p>MPLS-VPN需求：</p><ol><li><p>总公司的PC能访问分公司1/2的PC，分公司之间不能互访</p></li><li><p>R1和SW3、SW4之间运行OSPF协议</p></li><li><p>R4和R5之间运行BGP协议</p></li><li><p>R4和R6之间运行OSPF协议</p></li><li><p>R1和R4建立MP-BGP邻居</p></li></ol></li><li><p>分公司1需求：</p><ol><li>SW5为二层交换机，PC5与PC6配置不同VLAN（属于不同网段），确保两台PC能互访</li></ol></li><li><p>分公司2需求：</p><ol start="2"><li><p>PC8与PC7属于不同VLAN（相同网段），通过VLANIF技术让两台PC正常访问总公司，但是不能互访</p></li><li><p>内部IGP运行OSPF协议，为了加快收敛速度，每网段不允许存在DR</p></li></ol></li></ul><h3 id="要求分析："><a href="#要求分析：" class="headerlink" title="要求分析："></a>要求分析：</h3><hr><ul><li><p>实验拓扑很大，实验要求很多，但是我们将此划分成若各小部分就可以了</p></li><li><p>配置总公司，链路聚合和MSTP被明确提出，并表明了谁为ROOT，网关冗余就是VRRP，不过多加一个认证和BFD</p><ul><li>总公司配置：动态链路聚合/MSTP/VRRP/VRRP认证/VRRP BFD上行链路故障检测，</li></ul></li><li><p>配置分公司一：要求pc属于不同vlan，属于不同网段，但是可以互访，典型的单臂路由。</p><ul><li>分公司一配置：单臂路由</li></ul></li><li><p>配置分公司二：要求pc属于不同vlan，但是都可以通过vlan访问外网，且不能互访，想到是super-vlan，但是super-vlan间是可以互访的，所以关闭arp代理功能，让他们不能互访，且还需在内部运行OSPF协议，并且不能有DR,所以将链路类型改为p2p</p><ul><li>分公司二配置：super vlan/OSPF/修改OSPF链路类型</li></ul></li><li><p>配置MPLS-VPN：总公司可以访问两个分公司，两个分公司不能互访，通过两个vpn实例可以有效解决，然后就是CE与PE之间运行的各种协议。</p><ul><li><p>MPLS-VPN配置：</p><ul><li><p>AS 100内的isis协议</p></li><li><p>MPLS LDP/MPLS VPN/MP-BGP/</p></li><li><p>R1和SW3、SW4之间运行OSPF协议</p></li><li>R4和R5之间运行BGP协议</li><li>R4和R6之间运行OSPF协议</li></ul></li></ul></li></ul><h3 id="实验步骤："><a href="#实验步骤：" class="headerlink" title="实验步骤："></a>实验步骤：</h3><hr><ul><li><p>配置ip地址，ping直连检验连通性，配置loopback口地址，（略）</p></li><li><p>配置总公司：</p><ol><li><p>创建vlan，将vlan加入接口（略），</p></li><li><p>配置SW1-SW2-SW3-SW4的MSTP:</p><figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">[SW1]stp region-configuration </span><br><span class="line">[SW1-mst-region] region-name cfw   <span class="comment">//配置MSTP域的名称</span></span><br><span class="line">[SW1-mst-region] revision-level <span class="number">1</span>  <span class="comment">//配置MSTP等级</span></span><br><span class="line">[SW1-mst-region] instance <span class="number">1</span> vlan <span class="number">10</span>  <span class="comment">//创建实例1并将vlan10加入该实例</span></span><br><span class="line">[SW1-mst-region] instance <span class="number">2</span> vlan <span class="number">20</span> <span class="comment">//创建实例2并将vlan10加入该实例</span></span><br><span class="line">[SW1-mst-region] active region-configuration <span class="comment">//激活该MSTP域</span></span><br><span class="line"></span><br><span class="line">SW2,SW3跟SW4一样的配置，</span><br><span class="line"></span><br><span class="line">[SW3]stp instance <span class="number">1</span> root primary <span class="comment">//配置SW3为实例1的主根</span></span><br><span class="line">[SW3]stp instance <span class="number">2</span> root secondary  <span class="comment">//配置SW3为实例2的备份根</span></span><br><span class="line"></span><br><span class="line">#SW3,SW4相同的配置，反着来就行。</span><br></pre></td></tr></table></figure></li><li><p>查看MSTP状态：</p><figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br></pre></td><td class="code"><pre><span class="line">[SW3]dis stp instance <span class="number">1</span> </span><br><span class="line">-------[MSTI <span class="number">1</span> Global Info]-------</span><br><span class="line">MSTI Bridge ID      :<span class="number">0.4</span>c1f-cc06<span class="number">-74</span>f7  <span class="comment">//转发桥id</span></span><br><span class="line">MSTI RegRoot/IRPC   :<span class="number">0.4</span>c1f-cc06<span class="number">-74</span>f7 / <span class="number">0</span>  <span class="comment">//桥id</span></span><br><span class="line">MSTI RootPortId     :<span class="number">0.0</span>  <span class="comment">//根路劲开销为0</span></span><br><span class="line">MSTI Root Type      :Primary root</span><br><span class="line">Master Bridge       :<span class="number">32768.4</span>c1f-cc06<span class="number">-74</span>f7</span><br><span class="line">Cost to Master      :<span class="number">0</span></span><br><span class="line">TC received         :<span class="number">5</span></span><br><span class="line">TC count per hello  :<span class="number">0</span></span><br><span class="line">Time since last TC  :<span class="number">0</span> days <span class="number">0</span>h:<span class="number">4</span>m:<span class="number">44</span>s</span><br><span class="line"><span class="built_in">Number</span> <span class="keyword">of</span> TC        :<span class="number">6</span></span><br><span class="line">Last TC occurred    :GigabitEthernet0/<span class="number">0</span>/<span class="number">2</span></span><br><span class="line"> ----[Port2(GigabitEthernet0/<span class="number">0</span>/<span class="number">2</span>)][FORWARDING]----</span><br><span class="line"> Port Role           :Designated Port   <span class="comment">//端口类型为DP</span></span><br><span class="line"> Port Priority       :<span class="number">128</span></span><br><span class="line"> Port Cost(Dot1T )   :Config=auto / Active=<span class="number">20000</span></span><br><span class="line"> Designated Bridge/Port   :<span class="number">0.4</span>c1f-cc06<span class="number">-74</span>f7 / <span class="number">128.2</span></span><br><span class="line"> Port Times          :RemHops <span class="number">20</span></span><br><span class="line"> TC or TCN send      :<span class="number">4</span></span><br><span class="line"> TC or TCN received  :<span class="number">2</span></span><br><span class="line"> ----[Port3(GigabitEthernet0/<span class="number">0</span>/<span class="number">3</span>)][FORWARDING]----</span><br><span class="line"> Port Role           :Designated Port  <span class="comment">//端口类型为DP</span></span><br><span class="line"> Port Priority       :<span class="number">128</span></span><br><span class="line"> Port Cost(Dot1T )   :Config=auto / Active=<span class="number">20000</span></span><br><span class="line"> Designated Bridge/Port   :<span class="number">0.4</span>c1f-cc06<span class="number">-74</span>f7 / <span class="number">128.3</span></span><br><span class="line"> Port Times          :RemHops <span class="number">20</span></span><br><span class="line"> TC or TCN send      :<span class="number">6</span></span><br><span class="line"> TC or TCN received  :<span class="number">3</span></span><br><span class="line">[SW3]</span><br><span class="line"></span><br><span class="line">[SW4]dis stp instance <span class="number">2</span></span><br><span class="line">-------[MSTI <span class="number">2</span> Global Info]-------</span><br><span class="line">MSTI Bridge ID      :<span class="number">0.4</span>c1f-cc8e<span class="number">-4</span>dd9</span><br><span class="line">MSTI RegRoot/IRPC   :<span class="number">0.4</span>c1f-cc8e<span class="number">-4</span>dd9 / <span class="number">0</span></span><br><span class="line">MSTI RootPortId     :<span class="number">0.0</span></span><br><span class="line">MSTI Root Type      :Primary root</span><br><span class="line">Master Bridge       :<span class="number">32768.4</span>c1f-cc06<span class="number">-74</span>f7</span><br><span class="line">Cost to Master      :<span class="number">10000</span></span><br><span class="line">TC received         :<span class="number">13</span></span><br><span class="line">TC count per hello  :<span class="number">0</span></span><br><span class="line">Time since last TC  :<span class="number">0</span> days <span class="number">0</span>h:<span class="number">6</span>m:<span class="number">9</span>s</span><br><span class="line"><span class="built_in">Number</span> <span class="keyword">of</span> TC        :<span class="number">10</span></span><br><span class="line">Last TC occurred    :GigabitEthernet0/<span class="number">0</span>/<span class="number">3</span></span><br><span class="line"> ----[Port3(GigabitEthernet0/<span class="number">0</span>/<span class="number">2</span>)][FORWARDING]----</span><br><span class="line"> Port Role           :Designated Port</span><br><span class="line"> Port Priority       :<span class="number">128</span></span><br><span class="line"> Port Cost(Dot1T )   :Config=auto / Active=<span class="number">20000</span></span><br><span class="line"> Designated Bridge/Port   :<span class="number">0.4</span>c1f-cc8e<span class="number">-4</span>dd9 / <span class="number">128.3</span></span><br><span class="line"> Port Times          :RemHops <span class="number">20</span></span><br><span class="line"> TC or TCN send      :<span class="number">8</span></span><br><span class="line"> TC or TCN received  :<span class="number">10</span></span><br><span class="line"> ----[Port4(GigabitEthernet0/<span class="number">0</span>/<span class="number">3</span>)][FORWARDING]----</span><br><span class="line"> Port Role           :Designated Port</span><br><span class="line"> Port Priority       :<span class="number">128</span></span><br><span class="line"> Port Cost(Dot1T )   :Config=auto / Active=<span class="number">20000</span></span><br><span class="line"> Designated Bridge/Port   :<span class="number">0.4</span>c1f-cc8e<span class="number">-4</span>dd9 / <span class="number">128.4</span></span><br><span class="line"> Port Times          :RemHops <span class="number">20</span></span><br><span class="line"> TC or TCN send      :<span class="number">9</span></span><br><span class="line"> TC or TCN received  :<span class="number">3</span></span><br><span class="line"> ----[Port1(Eth-Trunk1)][FORWARDING]----</span><br><span class="line"> Port Role           :Designated Port</span><br><span class="line"> Port Priority       :<span class="number">128</span></span><br><span class="line"> Port Cost(Dot1T )   :Config=auto / Active=<span class="number">10000</span></span><br><span class="line"> Designated Bridge/Port   :<span class="number">0.4</span>c1f-cc8e<span class="number">-4</span>dd9 / <span class="number">128.1</span></span><br><span class="line"> Port Times          :RemHops <span class="number">20</span></span><br><span class="line"> TC or TCN send      :<span class="number">9</span></span><br><span class="line"> TC or TCN received  :<span class="number">0</span></span><br><span class="line">[SW4]</span><br><span class="line"></span><br><span class="line">#SW3为实例1的root，实例4为实例2的root。</span><br></pre></td></tr></table></figure></li><li><p>配置动态链路聚合：</p><figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">[SW4]<span class="keyword">in</span> eth <span class="number">1</span></span><br><span class="line">[SW4-Eth-Trunk1]mode lacp-<span class="keyword">static</span>  <span class="comment">//配置静态lacp</span></span><br><span class="line">[SW4-Eth-Trunk1]max active-linknumber <span class="number">2</span>  <span class="comment">//修改最大活跃链路为2</span></span><br><span class="line">[SW4-Eth-Trunk1]port link-type trunk</span><br><span class="line">[SW4-Eth-Trunk1]port trunk allow-pass vlan <span class="number">10</span> <span class="number">20</span></span><br><span class="line"></span><br><span class="line">#题目要求最大带宽为2G,说明要求最大活跃链路为2 ，可以通过静态LACP来完成：</span><br></pre></td></tr></table></figure></li><li><p>查看链路聚合状态：</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">[SW3]dis eth <span class="number">1</span></span><br><span class="line">Eth-Trunk1<span class="string">'s state information is:</span></span><br><span class="line"><span class="string">Local:</span></span><br><span class="line"><span class="string">LAG ID: 1                   WorkingMode: STATIC                               </span></span><br><span class="line"><span class="string">Preempt Delay: Disabled     Hash arithmetic: According to SIP-XOR-DIP         </span></span><br><span class="line"><span class="string">System Priority: 32768      System ID: 4c1f-cc06-74f7                         </span></span><br><span class="line"><span class="string">Least Active-linknumber: 1  Max Active-linknumber: 2                          </span></span><br><span class="line"><span class="string">Operate status: up          Number Of Up Port In Trunk: 2                     </span></span><br><span class="line"><span class="string">--------------------------------------------------------------------------------</span></span><br><span class="line"><span class="string">ActorPortName          Status   PortType PortPri PortNo PortKey PortState Weight</span></span><br><span class="line"><span class="string">GigabitEthernet0/0/1   Selected 1GE      32768   2      305     10111100  1     </span></span><br><span class="line"><span class="string">GigabitEthernet0/0/4   Selected 1GE      32768   5      305     10111100  1     </span></span><br><span class="line"><span class="string">GigabitEthernet0/0/5   Unselect 1GE      32768   6      305     10100000  1     </span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">Partner:</span></span><br><span class="line"><span class="string">--------------------------------------------------------------------------------</span></span><br><span class="line"><span class="string">ActorPortName          SysPri   SystemID        PortPri PortNo PortKey PortState</span></span><br><span class="line"><span class="string">GigabitEthernet0/0/1   32768    4c1f-cc8e-4dd9  32768   2      305     10111100</span></span><br><span class="line"><span class="string">GigabitEthernet0/0/4   32768    4c1f-cc8e-4dd9  32768   5      305     10111100</span></span><br><span class="line"><span class="string">GigabitEthernet0/0/5   32768    4c1f-cc8e-4dd9  32768   6      305     10100000</span></span><br><span class="line"><span class="string">    </span></span><br><span class="line"><span class="string">[SW3]</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">#发现g0/0/1和g0/0/4状态为seleted，g0/0/5状态为unselect，说明0/1口和0/4口是活跃了。且带宽加起来正好为2.</span></span><br></pre></td></tr></table></figure></li><li><p>配置VRRP：</p><figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">[SW3-Vlanif10]vrrp vrid <span class="number">1</span> virtual-ip <span class="number">192.168</span><span class="number">.10</span><span class="number">.254</span> <span class="comment">//配置vrrp组1的虚拟网关为192.168.10.254</span></span><br><span class="line">[SW3-Vlanif10]vrrp vrid <span class="number">1</span> priority <span class="number">150</span> <span class="comment">//配置vrrp组一的优先级为150</span></span><br><span class="line">[SW3-Vlanif10]vrrp vrid <span class="number">1</span> authentication-mode md5 huawei  <span class="comment">//配置vrrp组一的MD5认证</span></span><br><span class="line"></span><br><span class="line">[SW4-Vlanif10]vrrp vrid <span class="number">1</span> virtual-ip <span class="number">192.168</span><span class="number">.10</span><span class="number">.254</span></span><br><span class="line">[SW4-Vlanif10]vrrp vrid <span class="number">1</span> authentication-mode md5 huawei </span><br><span class="line"></span><br><span class="line">#vrrp认证有两种，一种是md5，一种是simple，亲测配置为simple，两边状态都为master。所以我们还是用md5.</span><br><span class="line">#两边配置一模一样，这里仅取VRRP组一的配置</span><br></pre></td></tr></table></figure></li><li><p>查看vrrp组一状态：</p><figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line">[SW3]dis vrrp <span class="number">1</span></span><br><span class="line">  Vlanif10 | Virtual Router <span class="number">1</span></span><br><span class="line">    State : Master</span><br><span class="line">    Virtual IP : <span class="number">192.168</span><span class="number">.10</span><span class="number">.254</span></span><br><span class="line">    Master IP : <span class="number">192.168</span><span class="number">.10</span><span class="number">.252</span></span><br><span class="line">    PriorityRun : <span class="number">150</span></span><br><span class="line">    PriorityConfig : <span class="number">150</span></span><br><span class="line">    MasterPriority : <span class="number">150</span></span><br><span class="line">    Preempt : YES   Delay Time : <span class="number">0</span> s</span><br><span class="line">    TimerRun : <span class="number">1</span> s</span><br><span class="line">    TimerConfig : <span class="number">1</span> s</span><br><span class="line">    Auth type : MD5   Auth key : Zm~.C3k[ND$+cx#k/mS=p_M#  </span><br><span class="line">    Virtual MAC : <span class="number">0000</span><span class="number">-5e00</span><span class="number">-0101</span></span><br><span class="line">    Check TTL : YES</span><br><span class="line">    Config type : normal-vrrp</span><br><span class="line">    Create time : <span class="number">2019</span><span class="number">-04</span><span class="number">-27</span> <span class="number">13</span>:<span class="number">19</span>:<span class="number">09</span> UTC<span class="number">-08</span>:<span class="number">00</span></span><br><span class="line">    Last change time : <span class="number">2019</span><span class="number">-04</span><span class="number">-27</span> <span class="number">13</span>:<span class="number">19</span>:<span class="number">13</span> UTC<span class="number">-08</span>:<span class="number">00</span></span><br><span class="line"></span><br><span class="line">[SW3]</span><br><span class="line"></span><br><span class="line">[SW4]dis vrrp  <span class="number">1</span></span><br><span class="line">  Vlanif10 | Virtual Router <span class="number">1</span></span><br><span class="line">    State : Backup</span><br><span class="line">    Virtual IP : <span class="number">192.168</span><span class="number">.10</span><span class="number">.254</span></span><br><span class="line">    Master IP : <span class="number">192.168</span><span class="number">.10</span><span class="number">.252</span></span><br><span class="line">    PriorityRun : <span class="number">100</span>  <span class="comment">//本地优先级为100，默认为100</span></span><br><span class="line">    PriorityConfig : <span class="number">100</span></span><br><span class="line">    MasterPriority : <span class="number">150</span>  <span class="comment">//master优先级为150</span></span><br><span class="line">    Preempt : YES   Delay Time : <span class="number">0</span> s</span><br><span class="line">    TimerRun : <span class="number">1</span> s</span><br><span class="line">    TimerConfig : <span class="number">1</span> s</span><br><span class="line">    Auth type : MD5   Auth key : 1!9d=^g7u)^QW:LZJi;=J&gt;a#  //认证类型为MD5</span><br><span class="line">    Virtual MAC : <span class="number">0000</span><span class="number">-5e00</span><span class="number">-0101</span></span><br><span class="line">    Check TTL : YES</span><br><span class="line">    Config type : normal-vrrp</span><br><span class="line">    Create time : <span class="number">2019</span><span class="number">-04</span><span class="number">-27</span> <span class="number">12</span>:<span class="number">52</span>:<span class="number">05</span> UTC<span class="number">-08</span>:<span class="number">00</span></span><br><span class="line">    Last change time : <span class="number">2019</span><span class="number">-04</span><span class="number">-27</span> <span class="number">13</span>:<span class="number">25</span>:<span class="number">31</span> UTC<span class="number">-08</span>:<span class="number">00</span></span><br><span class="line"></span><br><span class="line">[SW4]</span><br><span class="line"></span><br><span class="line">#发现sw3为vrrp组一的master，sw4为vrrp组一的backup。</span><br></pre></td></tr></table></figure></li><li><p>配置vrrp bfd检测上行链路故障：</p><figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">[SW3]bfd   <span class="comment">//全局打开bfd</span></span><br><span class="line">[SW3]bfd cfw bind peer-ip <span class="number">192.168</span><span class="number">.13</span><span class="number">.1</span> interface Vlanif <span class="number">30</span> source-ip <span class="number">192.168</span><span class="number">.13</span>.</span><br><span class="line"><span class="number">3</span> auto   <span class="comment">//配置bfd名称为cfw，邻居为192.168.13.1 检测vlanif接口，源ip为192.168.13.3 自动创建本地标识符和源端标识符。</span></span><br><span class="line">[SW3-bfd-session-cfw]commit  <span class="comment">//提交配置</span></span><br><span class="line">[SW3-Vlanif10]vrrp vrid <span class="number">1</span> track bfd-session session-name cfw reduced <span class="number">100</span> <span class="comment">//使能VRRP通过联动BFD会话状态检测上行链路状态，执行动作为降低100优先级。</span></span><br><span class="line"></span><br><span class="line">#VRRP备份组与BFD联动，一般配置在master上，实时检测上行链路，当链路发生故障后，原先的master之间降低优先级，变为backup。</span><br></pre></td></tr></table></figure></li><li><p>查看BFD状态：</p><figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">[SW3]dis bfd session peer-ip <span class="number">192.168</span><span class="number">.13</span><span class="number">.1</span></span><br><span class="line">--------------------------------------------------------------------------------</span><br><span class="line">Local Remote     PeerIpAddr      State     Type        InterfaceName            </span><br><span class="line">--------------------------------------------------------------------------------</span><br><span class="line"></span><br><span class="line"><span class="number">8193</span>  <span class="number">0</span>          <span class="number">192.168</span><span class="number">.13</span><span class="number">.1</span>    Down      S_AUTO_IF   Vlanif30                 </span><br><span class="line">--------------------------------------------------------------------------------</span><br><span class="line">     Total UP/DOWN Session <span class="built_in">Number</span> : <span class="number">0</span>/<span class="number">1</span></span><br><span class="line">[SW3]</span><br><span class="line"></span><br><span class="line">#发现状态为DOWN,这是因为没有在接口下使能BFD,对端邻居的接口也要使能BFD</span><br></pre></td></tr></table></figure></li><li><p>接口使能BFD:</p><figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">[SW3-Vlanif30]ospf bfd enable  <span class="comment">//在OSPF的特定接口下使能BFD特性</span></span><br><span class="line">[R1-GigabitEthernet0/<span class="number">0</span>/<span class="number">0</span>]ospf bfd enable</span><br><span class="line"></span><br><span class="line">#BFD通常会跟IGP协议结合使用，动态的检测链路状态</span><br></pre></td></tr></table></figure></li><li><p>查看BFD状态：</p><figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">[SW3]dis bfd session all </span><br><span class="line">--------------------------------------------------------------------------------</span><br><span class="line">Local Remote     PeerIpAddr      State     Type        InterfaceName            </span><br><span class="line">--------------------------------------------------------------------------------</span><br><span class="line"></span><br><span class="line"><span class="number">8193</span>  <span class="number">8197</span>       <span class="number">192.168</span><span class="number">.13</span><span class="number">.1</span>    Up        S_AUTO_IF   Vlanif30                 </span><br><span class="line">--------------------------------------------------------------------------------</span><br><span class="line">     Total UP/DOWN Session <span class="built_in">Number</span> : <span class="number">1</span>/<span class="number">0</span></span><br><span class="line">[SW3]</span><br><span class="line"></span><br><span class="line">#状态已经up了，这是我们就可以验证了，关闭g0/0/6口，查看VRRP组一是否会发生变化</span><br></pre></td></tr></table></figure></li><li><p>关闭g0/0/6,查看VRRP组一：</p><figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">[SW3-GigabitEthernet0/<span class="number">0</span>/<span class="number">6</span>]shutdown </span><br><span class="line"></span><br><span class="line">[SW3]dis vrrp <span class="number">1</span> </span><br><span class="line">  Vlanif10 | Virtual Router <span class="number">1</span></span><br><span class="line">    State : Backup    <span class="comment">//转台为backup</span></span><br><span class="line">    Virtual IP : <span class="number">192.168</span><span class="number">.10</span><span class="number">.254</span></span><br><span class="line">    Master IP : <span class="number">192.168</span><span class="number">.10</span><span class="number">.253</span></span><br><span class="line">    PriorityRun : <span class="number">50</span>  <span class="comment">//本地优先级改为了50</span></span><br><span class="line">    PriorityConfig : <span class="number">150</span>  <span class="comment">//原先优先级为150</span></span><br><span class="line">    MasterPriority : <span class="number">100</span>  <span class="comment">//master的优先级为100</span></span><br><span class="line">    Preempt : YES   Delay Time : <span class="number">0</span> s</span><br><span class="line">    TimerRun : <span class="number">1</span> s</span><br><span class="line">    TimerConfig : <span class="number">1</span> s</span><br><span class="line">    Auth type : MD5   Auth key : Zm~.C3k[ND$+cx#k/mS=p_M#</span><br><span class="line">    Virtual MAC : <span class="number">0000</span><span class="number">-5e00</span><span class="number">-0101</span></span><br><span class="line">    Check TTL : YES</span><br><span class="line">    Config type : normal-vrrp</span><br><span class="line">    Track BFD : cfw  Priority reduced : <span class="number">100</span></span><br><span class="line">    BFD-session state : DOWN   <span class="comment">//bfd状态为down</span></span><br><span class="line">    Create time : <span class="number">2019</span><span class="number">-04</span><span class="number">-27</span> <span class="number">13</span>:<span class="number">19</span>:<span class="number">09</span> UTC<span class="number">-08</span>:<span class="number">00</span></span><br><span class="line">    Last change time : <span class="number">2019</span><span class="number">-04</span><span class="number">-27</span> <span class="number">17</span>:<span class="number">59</span>:<span class="number">29</span> UTC<span class="number">-08</span>:<span class="number">00</span></span><br><span class="line"></span><br><span class="line">[SW3]</span><br><span class="line"></span><br><span class="line">#发现当上行链路故障之后，master自动降低优先级，成为了backup，实现了主备之前的切换，完成实验。</span><br></pre></td></tr></table></figure></li><li><p>抓包分析：</p><p><img src="/2019/05/10/HCIP综合实验/E:/MD保存文件\1556359756198.png" alt="1556359756198"></p><blockquote><p>BFD报文，基于UDP协议，协议号为3784，单跳检测的为3784，多条检测为4784/3784</p></blockquote><p><img src="/2019/05/10/HCIP综合实验/E:/MD保存文件\1556360072017.png" alt="1556360072017"></p><blockquote><p>当上行链路故障后，宣告报文会将降低的优先级填写进去，然后发送给邻居，进行状态切换</p></blockquote></li></ol></li><li><p>配置分公司一：</p><ol><li><p>配置SW5二层交换机的vlan，并将vlan加入对应的接口（略)</p></li><li><p>配置单臂路由：</p><figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">[R5]<span class="keyword">in</span> g <span class="number">0</span>/<span class="number">0</span>/<span class="number">1.10</span></span><br><span class="line">[R5-GigabitEthernet0/<span class="number">0</span>/<span class="number">1.10</span>]dot1q termination vid <span class="number">10</span>  <span class="comment">//配置子接口Dot1q终结的单层VLAN ID</span></span><br><span class="line">[R5-GigabitEthernet0/<span class="number">0</span>/<span class="number">1.10</span>]ip address <span class="number">192.168</span><span class="number">.55</span><span class="number">.254</span> <span class="number">255.255</span><span class="number">.255</span><span class="number">.0</span> </span><br><span class="line">[R5-GigabitEthernet0/<span class="number">0</span>/<span class="number">1.10</span>]arp broadcast enable  <span class="comment">//开启arp代理</span></span><br><span class="line"></span><br><span class="line">#题目要求不同网段，不同vlan，但是要求可以互通，那么就想到了单臂路由</span><br></pre></td></tr></table></figure></li></ol></li><li><p>配置分公司二：</p><ol><li><p>创建vlan，配置supper-vlan:</p><figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">[SW7]vlan <span class="number">30</span> </span><br><span class="line">[SW7-vlan30]aggregate-vlan <span class="comment">//配置vlan30位super-vlan</span></span><br><span class="line">[SW7-vlan30]access-vlan <span class="number">10</span> <span class="number">20</span>  <span class="comment">//配置vlan10 20 为vlan30的sub-vlan</span></span><br><span class="line">[SW7]int vlan <span class="number">30</span> </span><br><span class="line">[SW7-Vlanif30]ip add <span class="number">192.168</span><span class="number">.78</span><span class="number">.254</span> <span class="number">24</span></span><br><span class="line"></span><br><span class="line">#题目要求先相同网段，不同vlan，要求不能互通，想到了super-vlan，但是super-vlan之间是可以互通的，所以想到了关闭arp代理功能，但是因为arp代理默认就是关闭的，所以我们就不用进行配置了。</span><br><span class="line">#基本的配置的话，是要开启vlan间 arp代理的，但是题目要求不能进行互访，所以没有开启ARP代理，</span><br></pre></td></tr></table></figure></li><li><p>配置分公司OSPF:</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">[R6]ospf <span class="number">200</span> router-id <span class="number">6.6</span><span class="number">.6</span><span class="number">.6</span> </span><br><span class="line">[R6-ospf<span class="number">-200</span>]area <span class="number">0</span></span><br><span class="line">[R6-ospf<span class="number">-200</span>-area<span class="number">-0.0</span><span class="number">.0</span><span class="number">.0</span>]network <span class="number">6.6</span><span class="number">.6</span><span class="number">.6</span> <span class="number">0.0</span><span class="number">.0</span><span class="number">.0</span> </span><br><span class="line">[R6-ospf<span class="number">-200</span>-area<span class="number">-0.0</span><span class="number">.0</span><span class="number">.0</span>]network <span class="number">192.168</span><span class="number">.67</span><span class="number">.6</span> <span class="number">0.0</span><span class="number">.0</span><span class="number">.0</span> </span><br><span class="line"></span><br><span class="line">[SW7]ospf <span class="number">200</span> router-id <span class="number">7.7</span><span class="number">.7</span><span class="number">.7</span></span><br><span class="line">[SW7-ospf<span class="number">-200</span>]area <span class="number">0</span></span><br><span class="line">[SW7-ospf<span class="number">-200</span>-area<span class="number">-0.0</span><span class="number">.0</span><span class="number">.0</span>]network <span class="number">192.168</span><span class="number">.67</span><span class="number">.7</span> <span class="number">0.0</span><span class="number">.0</span><span class="number">.0</span> </span><br><span class="line">[SW7-ospf<span class="number">-200</span>-area<span class="number">-0.0</span><span class="number">.0</span><span class="number">.0</span>]network <span class="number">7.7</span><span class="number">.7</span><span class="number">.7</span> <span class="number">0.0</span><span class="number">.0</span><span class="number">.0</span></span><br></pre></td></tr></table></figure></li><li><p>查看OSPF状态：</p><figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">[R6]dis ospf peer brief</span><br><span class="line"></span><br><span class="line"> OSPF Process <span class="number">200</span> <span class="keyword">with</span> Router ID <span class="number">6.6</span><span class="number">.6</span><span class="number">.6</span></span><br><span class="line">  Peer Statistic Information</span><br><span class="line"> ----------------------------------------------------------------------------</span><br><span class="line"> Area Id          Interface                        Neighbor id      State    </span><br><span class="line"> <span class="number">0.0</span><span class="number">.0</span><span class="number">.0</span>          GigabitEthernet0/<span class="number">0</span>/<span class="number">0</span>             <span class="number">10.1</span><span class="number">.46</span><span class="number">.4</span>        Full        </span><br><span class="line"> <span class="number">0.0</span><span class="number">.0</span><span class="number">.0</span>          GigabitEthernet0/<span class="number">0</span>/<span class="number">1</span>             <span class="number">7.7</span><span class="number">.7</span><span class="number">.7</span>          Full        </span><br><span class="line"> ----------------------------------------------------------------------------</span><br><span class="line">[R6]</span><br><span class="line"></span><br><span class="line">#当状态为full，代表邻接关系建立成功了。</span><br></pre></td></tr></table></figure></li><li><p>查看OSPF接口状态：</p><figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">[SW7]dis ospf interface Vlanif <span class="number">40</span></span><br><span class="line"></span><br><span class="line"> OSPF Process <span class="number">200</span> <span class="keyword">with</span> Router ID <span class="number">7.7</span><span class="number">.7</span><span class="number">.7</span></span><br><span class="line"> Interfaces </span><br><span class="line"></span><br><span class="line"></span><br><span class="line"> Interface: <span class="number">192.168</span><span class="number">.67</span><span class="number">.7</span> (Vlanif40)</span><br><span class="line"> Cost: <span class="number">1</span>       State: DR        Type: Broadcast    MTU: <span class="number">1500</span>  </span><br><span class="line"> Priority: <span class="number">1</span></span><br><span class="line"> Designated Router: <span class="number">192.168</span><span class="number">.67</span><span class="number">.7</span></span><br><span class="line"> Backup Designated Router: <span class="number">192.168</span><span class="number">.67</span><span class="number">.6</span></span><br><span class="line"> Timers: Hello <span class="number">10</span> , Dead <span class="number">40</span> , Poll  <span class="number">120</span> , Retransmit <span class="number">5</span> , Transmit Delay <span class="number">1</span> </span><br><span class="line">[SW7]</span><br><span class="line"></span><br><span class="line">#发现此接口为DR,是因为这是MA链路类型，在邻居关系建立之后，就会选举DR,(先比较优先级，默认为1，在比较R-ID,都比大)，但是题目要求不能有DR,所以我们要将接口类型该为p2p.</span><br></pre></td></tr></table></figure></li><li><p>修改OSPF区域内所有接口的网络类型:</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">[R6-GigabitEthernet0/<span class="number">0</span>/<span class="number">1</span>]ospf network-type p2p  <span class="comment">//修改链路类型为p2p</span></span><br><span class="line"></span><br><span class="line">[SW7-Vlanif40]ospf network-type p2p</span><br></pre></td></tr></table></figure></li><li><p>再次查看OSPF接口状态：</p><figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">[SW7]dis ospf interface Vlanif <span class="number">40</span></span><br><span class="line"></span><br><span class="line"> OSPF Process <span class="number">200</span> <span class="keyword">with</span> Router ID <span class="number">7.7</span><span class="number">.7</span><span class="number">.7</span></span><br><span class="line"> Interfaces </span><br><span class="line"></span><br><span class="line"></span><br><span class="line"> Interface: <span class="number">192.168</span><span class="number">.67</span><span class="number">.7</span> (Vlanif40) --&gt; <span class="number">192.168</span><span class="number">.67</span><span class="number">.6</span></span><br><span class="line"> Cost: <span class="number">1</span>       State: P<span class="number">-2</span>-P     Type: P2P       MTU: <span class="number">1500</span>  </span><br><span class="line"> Timers: Hello <span class="number">10</span> , Dead <span class="number">40</span> , Poll  <span class="number">120</span> , Retransmit <span class="number">5</span> , Transmit Delay <span class="number">1</span> </span><br><span class="line">[SW7]</span><br><span class="line"></span><br><span class="line">#状态为P-2-P,已经没有了DR的存在，达成题目要求。</span><br><span class="line">#到这一步，所以的基础配置就已经全部完成，接下来就是MPLS vpn</span><br></pre></td></tr></table></figure></li></ol></li><li><p>配置MPLS-VPN</p><ol><li><p>部署AS区域底层isis协议</p><figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">[R1]isis <span class="number">1</span></span><br><span class="line">[R1-isis<span class="number">-1</span>]is-level level<span class="number">-2</span></span><br><span class="line">[R1-isis<span class="number">-1</span>]network-entity <span class="number">49.0001</span><span class="number">.0001</span><span class="number">.0000</span><span class="number">.0000</span><span class="number">.0001</span><span class="number">.00</span></span><br><span class="line">[R1-GigabitEthernet0/<span class="number">0</span>/<span class="number">2</span>] isis enable <span class="number">1</span></span><br><span class="line">[R1-GigabitEthernet4/<span class="number">0</span>/<span class="number">0</span>] isis enable <span class="number">1</span></span><br><span class="line">[R1-LoopBack0] isis enable <span class="number">1</span></span><br><span class="line"></span><br><span class="line">#取R1的配置，所有的路由器上都是一样的配置。</span><br></pre></td></tr></table></figure></li><li><p>查看ISIS状态：</p><figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">[R1]dis isis peer </span><br><span class="line"></span><br><span class="line">                          Peer information <span class="keyword">for</span> ISIS(<span class="number">1</span>)</span><br><span class="line"></span><br><span class="line">  System Id     Interface          Circuit Id       State HoldTime Type     PRI</span><br><span class="line">-------------------------------------------------------------------------------</span><br><span class="line"><span class="number">0000.0000</span><span class="number">.0002</span>  GE0/<span class="number">0</span>/<span class="number">2</span>            <span class="number">0000.0000</span><span class="number">.0001</span><span class="number">.01</span> Up   <span class="number">22</span>s      L2       <span class="number">64</span> </span><br><span class="line"><span class="number">0000.0000</span><span class="number">.0003</span>  GE4/<span class="number">0</span>/<span class="number">0</span>            <span class="number">0000.0000</span><span class="number">.0001</span><span class="number">.02</span> Up   <span class="number">30</span>s      L2       <span class="number">64</span> </span><br><span class="line"></span><br><span class="line">Total Peer(s): <span class="number">2</span></span><br><span class="line">[R1]</span><br><span class="line"></span><br><span class="line">#状态全部为up。</span><br></pre></td></tr></table></figure><ol start="3"><li>开启MPLS区域的MPLS,及MPLS LDP协议</li></ol><figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">[R3]mpls lsr‐id <span class="number">3.3</span><span class="number">.3</span><span class="number">.3</span>  ‐‐配置lsr id</span><br><span class="line">[R3]mpls ‐‐开启MPLS</span><br><span class="line">[R3]mpls ldp ‐‐开启 mpls ldp</span><br><span class="line">[R3]<span class="keyword">in</span> g <span class="number">0</span>/<span class="number">0</span>/<span class="number">0</span></span><br><span class="line">[R3‐GigabitEthernet0/<span class="number">0</span>/<span class="number">0</span>]mpls ‐‐接口模式开启mpls</span><br><span class="line">[R3‐GigabitEthernet0/<span class="number">0</span>/<span class="number">0</span>]mpls ldp ‐‐接口模式开启mpls ldp</span><br><span class="line">[R3]<span class="keyword">in</span> g <span class="number">0</span>/<span class="number">0</span>/<span class="number">1</span></span><br><span class="line">[R3‐GigabitEthernet0/<span class="number">0</span>/<span class="number">1</span>]mpls ‐‐接口模式开启mpls</span><br><span class="line">[R3‐GigabitEthernet0/<span class="number">0</span>/<span class="number">1</span>]mpls ldp ‐‐接口模式开启mpls ldp</span><br><span class="line"></span><br><span class="line">#取R3配置，所有路由器的配置相同。</span><br></pre></td></tr></table></figure><ol start="4"><li>查看MPLS LDP状态：</li></ol><figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">[R3]dis mpls ldp session all </span><br><span class="line"></span><br><span class="line"> LDP Session(s) <span class="keyword">in</span> Public Network</span><br><span class="line"> Codes: LAM(Label Advertisement Mode), SsnAge Unit(DDDD:HH:MM)</span><br><span class="line"> A <span class="string">'*'</span> before a session means the session is being deleted.</span><br><span class="line"> ------------------------------------------------------------------------------</span><br><span class="line"> PeerID             Status      LAM  SsnRole  SsnAge      KASent/Rcv</span><br><span class="line"> ------------------------------------------------------------------------------</span><br><span class="line"> <span class="number">1.1</span><span class="number">.1</span><span class="number">.1</span>:<span class="number">0</span>          Operational DU   Active   <span class="number">0000</span>:<span class="number">02</span>:<span class="number">22</span>  <span class="number">569</span>/<span class="number">569</span></span><br><span class="line"> <span class="number">4.4</span><span class="number">.4</span><span class="number">.4</span>:<span class="number">0</span>          Operational DU   Passive  <span class="number">0000</span>:<span class="number">02</span>:<span class="number">22</span>  <span class="number">570</span>/<span class="number">570</span></span><br><span class="line"> ------------------------------------------------------------------------------</span><br><span class="line"> TOTAL: <span class="number">2</span> session(s) Found.</span><br><span class="line"></span><br><span class="line">[R3]</span><br><span class="line"></span><br><span class="line">#状态为Operational，LDP会话建立成功</span><br></pre></td></tr></table></figure><ol start="5"><li>在PE设备上部署VPN实例，并配置RD与RT属性</li></ol><figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line">[R1]ip vpn-instance <span class="number">1</span> </span><br><span class="line">[R1-vpn-instance<span class="number">-1</span>]route-distinguisher <span class="number">100</span>:<span class="number">100</span> <span class="comment">//配置RD属性为100:100</span></span><br><span class="line">[R1-vpn-instance<span class="number">-1</span>-af-ipv4]vpn-target <span class="number">100</span>:<span class="number">100</span> <span class="keyword">export</span>-extcommunity  <span class="comment">//配置RT 出属性为100:100</span></span><br><span class="line">[R1-vpn-instance<span class="number">-1</span>-af-ipv4]vpn-target <span class="number">100</span>:<span class="number">100</span> <span class="keyword">import</span>-extcommunity  <span class="comment">////配置RT 进属性为100:100</span></span><br><span class="line">[R1-GigabitEthernet0/<span class="number">0</span>/<span class="number">0</span>]ip binding vpn-instance <span class="number">1</span>  <span class="comment">//在接口下绑定vpn实例1</span></span><br><span class="line">[R1-GigabitEthernet0/<span class="number">0</span>/<span class="number">0</span>]ip address <span class="number">192.168</span><span class="number">.13</span><span class="number">.1</span> <span class="number">255.255</span><span class="number">.255</span><span class="number">.0</span> <span class="comment">//重新配置ip</span></span><br><span class="line"></span><br><span class="line">[R1]ip vpn-instance <span class="number">2</span></span><br><span class="line">[R1-vpn-instance<span class="number">-2</span>]route-distinguisher <span class="number">200</span>:<span class="number">200</span></span><br><span class="line">[R1-vpn-instance<span class="number">-2</span>-af-ipv4]vpn-target <span class="number">200</span>:<span class="number">200</span> <span class="keyword">export</span>-extcommunity</span><br><span class="line">[R1-vpn-instance<span class="number">-2</span>-af-ipv4]vpn-target <span class="number">200</span>:<span class="number">200</span> <span class="keyword">import</span>-extcommunity</span><br><span class="line">[R1-GigabitEthernet0/<span class="number">0</span>/<span class="number">1</span>]ip binding vpn-instance <span class="number">2</span>  </span><br><span class="line">[R1-GigabitEthernet0/<span class="number">0</span>/<span class="number">1</span>]ip address <span class="number">192.168</span><span class="number">.14</span><span class="number">.1</span> <span class="number">255.255</span><span class="number">.255</span><span class="number">.0</span> </span><br><span class="line"></span><br><span class="line"></span><br><span class="line">[R4]ip vpn-instance <span class="number">1</span> </span><br><span class="line">[R4-vpn-instance<span class="number">-1</span>]route-distinguisher <span class="number">100</span>:<span class="number">100</span> <span class="comment">//配置RD属性为100:100</span></span><br><span class="line">[R4-vpn-instance<span class="number">-1</span>-af-ipv4]vpn-target <span class="number">100</span>:<span class="number">100</span> <span class="keyword">export</span>-extcommunity  <span class="comment">//配置RT 出属性为100:100</span></span><br><span class="line">[R4-vpn-instance<span class="number">-1</span>-af-ipv4]vpn-target <span class="number">100</span>:<span class="number">100</span> <span class="keyword">import</span>-extcommunity  <span class="comment">////配置RT 进属性为100:100</span></span><br><span class="line">[R4-GigabitEthernet4/<span class="number">0</span>/<span class="number">0</span>]ip binding vpn-instance <span class="number">1</span></span><br><span class="line">[R4-GigabitEthernet4/<span class="number">0</span>/<span class="number">0</span>]ip address <span class="number">10.1</span><span class="number">.46</span><span class="number">.4</span> <span class="number">255.255</span><span class="number">.255</span><span class="number">.0</span> </span><br><span class="line"></span><br><span class="line">[R4]ip vpn-instance <span class="number">2</span></span><br><span class="line">[R4-vpn-instance<span class="number">-2</span>]route-distinguisher <span class="number">200</span>:<span class="number">200</span></span><br><span class="line">[R4-vpn-instance<span class="number">-2</span>-af-ipv4]vpn-target <span class="number">200</span>:<span class="number">200</span> <span class="keyword">export</span>-extcommunity</span><br><span class="line">[R4-vpn-instance<span class="number">-2</span>-af-ipv4]vpn-target <span class="number">200</span>:<span class="number">200</span> <span class="keyword">import</span>-extcommunity</span><br><span class="line">[R4-GigabitEthernet0/<span class="number">0</span>/<span class="number">2</span>]ip binding vpn-instance <span class="number">2</span></span><br><span class="line">[R4-GigabitEthernet0/<span class="number">0</span>/<span class="number">2</span>]ip address <span class="number">10.1</span><span class="number">.45</span><span class="number">.4</span> <span class="number">255.255</span><span class="number">.255</span><span class="number">.0</span> </span><br><span class="line"></span><br><span class="line">#RD,RT值的意义我们就不在过多的赘述了，</span><br><span class="line">#我们主要的还是要了解为啥要这样设置vpn实例，先看一下题目要求，要求总公司可以和分公司互访，但是分公司之间不能互访。</span><br><span class="line">#所以我们还是要配置两个vpn实例的，总公司那边配置两个实例，和分公司那边的实例做一一对应的关系，每隔分公司配置一个实例，只与总公司对应，便完成了我们的实验目的。</span><br></pre></td></tr></table></figure></li><li><p>在PE设备间部署MP-BGP协议</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">[R1]bgp <span class="number">100</span></span><br><span class="line">[R1-bgp]peer <span class="number">4.4</span><span class="number">.4</span><span class="number">.4</span> <span class="keyword">as</span>-number <span class="number">100</span> </span><br><span class="line">[R1-bgp]peer <span class="number">4.4</span><span class="number">.4</span><span class="number">.4</span> connect-interface LoopBack0</span><br><span class="line">[R1-bgp]ipv4-family vpnv4  <span class="comment">//进入BGP-VPNv4地址族视图。 </span></span><br><span class="line">[R1-bgp-af-vpnv4]peer <span class="number">4.4</span><span class="number">.4</span><span class="number">.4</span> enable  <span class="comment">//使能与4.4.4.4之间交换路由信息。</span></span><br><span class="line"></span><br><span class="line">[R4]bgp <span class="number">100</span></span><br><span class="line">[R4-bgp]peer <span class="number">1.1</span><span class="number">.1</span><span class="number">.1</span> <span class="keyword">as</span>-number <span class="number">100</span> </span><br><span class="line">[R4-bgp]peer <span class="number">1.1</span><span class="number">.1</span><span class="number">.1</span> connect-interface LoopBack0</span><br><span class="line">[R4-bgp]ipv4-family vpnv4  <span class="comment">//进入BGP-VPNv4地址族视图。 </span></span><br><span class="line">[R4-bgp-af-vpnv4]peer <span class="number">1.1</span><span class="number">.1</span><span class="number">.1</span> enable <span class="comment">//使能与1.1.1.1之间交换路由信息。</span></span><br></pre></td></tr></table></figure></li><li><p>查看MP-BGP状态：</p><figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">[R4]dis bgp vpnv4 all peer </span><br><span class="line"></span><br><span class="line"> BGP local router ID : <span class="number">10.1</span><span class="number">.24</span><span class="number">.4</span></span><br><span class="line"> Local AS number : <span class="number">100</span></span><br><span class="line"> Total number <span class="keyword">of</span> peers : <span class="number">2</span>  Peers <span class="keyword">in</span> established state : <span class="number">2</span></span><br><span class="line"></span><br><span class="line">  Peer            V          AS  MsgRcvd  MsgSent  OutQ  Up/Down       State Pre</span><br><span class="line">fRcv</span><br><span class="line"></span><br><span class="line">  <span class="number">1.1</span><span class="number">.1</span><span class="number">.1</span>         <span class="number">4</span>         <span class="number">100</span>      <span class="number">186</span>      <span class="number">158</span>     <span class="number">0</span> <span class="number">02</span>:<span class="number">31</span>:<span class="number">17</span> Established    </span><br><span class="line">   <span class="number">0</span></span><br><span class="line"></span><br><span class="line">[R4]</span><br><span class="line"></span><br><span class="line">#BGP邻居建立完成。</span><br></pre></td></tr></table></figure></li><li><p>部署PE-R4与CE-R6之间的OSPF路由协议:</p><figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">[R4]ospf <span class="number">200</span> vpn-instance <span class="number">1</span>  <span class="comment">//配置基于VPN实例1的OSPF</span></span><br><span class="line">[R4-ospf<span class="number">-200</span>]a <span class="number">0</span></span><br><span class="line">[R4-ospf<span class="number">-200</span>-area<span class="number">-0.0</span><span class="number">.0</span><span class="number">.0</span>]network <span class="number">10.1</span><span class="number">.46</span><span class="number">.4</span> <span class="number">0.0</span><span class="number">.0</span><span class="number">.0</span> </span><br><span class="line">[R4-ospf<span class="number">-200</span>-area<span class="number">-0.0</span><span class="number">.0</span><span class="number">.0</span>]network <span class="number">4.4</span><span class="number">.4</span><span class="number">.4</span> <span class="number">0.0</span><span class="number">.0</span><span class="number">.0</span></span><br><span class="line"></span><br><span class="line">[R6]ospf <span class="number">200</span></span><br><span class="line">[R6-ospf<span class="number">-200</span>]a <span class="number">0</span></span><br><span class="line">[R6-ospf<span class="number">-200</span>-area<span class="number">-0.0</span><span class="number">.0</span><span class="number">.0</span>]network <span class="number">10.1</span><span class="number">.46</span><span class="number">.6</span> <span class="number">0.0</span><span class="number">.0</span><span class="number">.0</span> </span><br><span class="line"></span><br><span class="line">#在这里要注意，两边的链路类型要是一致，刚在在R6上修改链路类型为p2p后，如果对端为以太网链路，那么依旧是可以建立起邻接关系的，因为他们的hello，dead时间都是一致的，所以可以建立起邻接关系，但是是不传递路由的，这里一定要注意</span><br></pre></td></tr></table></figure></li><li><p>查看OSPF状态：</p><figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">[R4]dis ospf pe b</span><br><span class="line"></span><br><span class="line"> OSPF Process <span class="number">200</span> <span class="keyword">with</span> Router ID <span class="number">10.1</span><span class="number">.46</span><span class="number">.4</span></span><br><span class="line">  Peer Statistic Information</span><br><span class="line"> ----------------------------------------------------------------------------</span><br><span class="line"> Area Id          Interface                        Neighbor id      State    </span><br><span class="line"> <span class="number">0.0</span><span class="number">.0</span><span class="number">.0</span>          GigabitEthernet4/<span class="number">0</span>/<span class="number">0</span>             <span class="number">6.6</span><span class="number">.6</span><span class="number">.6</span>          Full        </span><br><span class="line"> ----------------------------------------------------------------------------</span><br><span class="line">[R4]</span><br><span class="line"></span><br><span class="line">#OSPF邻接关系建立成功</span><br></pre></td></tr></table></figure></li><li><p>部署PE-R4与CE-R5之间的BGP路由协议:</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">[R4]bgp <span class="number">100</span></span><br><span class="line">[R4-bgp]ipv4-family vpn-instance <span class="number">2</span>  <span class="comment">//进入BGP-VPN实例视图</span></span><br><span class="line">[R4-bgp<span class="number">-2</span>]<span class="keyword">as</span>-number <span class="number">300</span>  <span class="comment">//创建新的AS号</span></span><br><span class="line">[R4-bgp<span class="number">-2</span>]peer <span class="number">10.1</span><span class="number">.45</span><span class="number">.5</span> <span class="keyword">as</span>-number <span class="number">200</span> <span class="comment">//手动指EBGP邻居</span></span><br><span class="line"></span><br><span class="line">[R5]bgp <span class="number">200</span></span><br><span class="line">[R5-bgp]peer <span class="number">10.1</span><span class="number">.45</span><span class="number">.4</span> <span class="keyword">as</span>-number <span class="number">300</span></span><br></pre></td></tr></table></figure></li><li><p>查看BGP状态：</p><figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">[R4]dis bgp vpnv4 all peer </span><br><span class="line"></span><br><span class="line"> BGP local router ID : <span class="number">10.1</span><span class="number">.24</span><span class="number">.4</span></span><br><span class="line"> Local AS number : <span class="number">100</span></span><br><span class="line"> Total number <span class="keyword">of</span> peers : <span class="number">2</span>  Peers <span class="keyword">in</span> established state : <span class="number">2</span></span><br><span class="line"></span><br><span class="line">  Peer            V          AS  MsgRcvd  MsgSent  OutQ  Up/Down       State Pre</span><br><span class="line">fRcv</span><br><span class="line"></span><br><span class="line">  <span class="number">1.1</span><span class="number">.1</span><span class="number">.1</span>         <span class="number">4</span>         <span class="number">100</span>      <span class="number">233</span>      <span class="number">205</span>     <span class="number">0</span> <span class="number">03</span>:<span class="number">18</span>:<span class="number">19</span> Established    </span><br><span class="line">   <span class="number">0</span></span><br><span class="line"></span><br><span class="line">  Peer <span class="keyword">of</span> IPv4-family <span class="keyword">for</span> vpn instance :</span><br><span class="line"></span><br><span class="line"> VPN-Instance <span class="number">2</span>, Router ID <span class="number">10.1</span><span class="number">.24</span><span class="number">.4</span>:</span><br><span class="line">  <span class="number">10.1</span><span class="number">.45</span><span class="number">.5</span>       <span class="number">4</span>         <span class="number">200</span>      <span class="number">202</span>      <span class="number">222</span>     <span class="number">0</span> <span class="number">03</span>:<span class="number">18</span>:<span class="number">42</span> Established    </span><br><span class="line">   <span class="number">2</span></span><br><span class="line">[R4]</span><br><span class="line"></span><br><span class="line">#发现有两个邻居，一个是IBGP邻居，意识EBGP邻居</span><br></pre></td></tr></table></figure></li><li><p>部署PE-R1与CE-SW3/SW4之间的OSPF路由协议:</p><figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">[R1]ospf <span class="number">1</span> vpn-instance <span class="number">1</span>  <span class="comment">//创建基于实例1的OSPF</span></span><br><span class="line">[R1-ospf<span class="number">-1</span>]area <span class="number">0</span></span><br><span class="line">[R1-ospf<span class="number">-1</span>-area<span class="number">-0.0</span><span class="number">.0</span><span class="number">.0</span>]network <span class="number">1.1</span><span class="number">.1</span><span class="number">.1</span> <span class="number">0.0</span><span class="number">.0</span><span class="number">.0</span> </span><br><span class="line">[R1-ospf<span class="number">-1</span>-area<span class="number">-0.0</span><span class="number">.0</span><span class="number">.0</span>]network <span class="number">192.168</span><span class="number">.13</span><span class="number">.1</span> <span class="number">0.0</span><span class="number">.0</span><span class="number">.0</span> </span><br><span class="line"></span><br><span class="line">[R1]ospf <span class="number">2</span> vpn-instance <span class="number">2</span></span><br><span class="line">[R1-ospf<span class="number">-2</span>]a <span class="number">0</span></span><br><span class="line">[R1-ospf<span class="number">-2</span>-area<span class="number">-0.0</span><span class="number">.0</span><span class="number">.0</span>]network <span class="number">192.168</span><span class="number">.14</span><span class="number">.1</span> <span class="number">0.0</span><span class="number">.0</span><span class="number">.0</span> </span><br><span class="line"></span><br><span class="line"></span><br><span class="line">[SW3]ospf <span class="number">1</span> </span><br><span class="line">[SW3-ospf<span class="number">-1</span>]a <span class="number">0</span></span><br><span class="line">[SW3-ospf<span class="number">-1</span>-area<span class="number">-0.0</span><span class="number">.0</span><span class="number">.0</span>]network <span class="number">192.168</span><span class="number">.13</span><span class="number">.3</span> <span class="number">0.0</span><span class="number">.0</span><span class="number">.0</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">[SW4]ospf <span class="number">1</span> </span><br><span class="line">[SW4-ospf<span class="number">-1</span>]a <span class="number">0</span></span><br><span class="line">[SW4-ospf<span class="number">-1</span>-area<span class="number">-0.0</span><span class="number">.0</span><span class="number">.0</span>]network <span class="number">192.168</span><span class="number">.14</span><span class="number">.4</span> <span class="number">0.0</span><span class="number">.0</span><span class="number">.0</span></span><br><span class="line">[SW4-ospf<span class="number">-1</span>-area<span class="number">-0.0</span><span class="number">.0</span><span class="number">.0</span>]network <span class="number">192.168</span><span class="number">.10</span><span class="number">.0</span> <span class="number">0.0</span><span class="number">.0</span><span class="number">.255</span></span><br><span class="line">[SW4-ospf<span class="number">-1</span>-area<span class="number">-0.0</span><span class="number">.0</span><span class="number">.0</span>]network <span class="number">192.168</span><span class="number">.20</span><span class="number">.0</span> <span class="number">0.0</span><span class="number">.0</span><span class="number">.255</span></span><br><span class="line"></span><br><span class="line">#因为有两个vpn实例，所以我们要创建分别基于两个实例的OSPF来让他们分别学习路由。</span><br></pre></td></tr></table></figure></li><li><p>查看OSPF状态：</p><figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">[R1]dis ospf peer brief </span><br><span class="line"></span><br><span class="line"> OSPF Process <span class="number">1</span> <span class="keyword">with</span> Router ID <span class="number">192.168</span><span class="number">.13</span><span class="number">.1</span></span><br><span class="line">  Peer Statistic Information</span><br><span class="line"> ----------------------------------------------------------------------------</span><br><span class="line"> Area Id          Interface                        Neighbor id      State    </span><br><span class="line"> <span class="number">0.0</span><span class="number">.0</span><span class="number">.0</span>          GigabitEthernet0/<span class="number">0</span>/<span class="number">0</span>             <span class="number">192.168</span><span class="number">.10</span><span class="number">.252</span>   Full        </span><br><span class="line"> ----------------------------------------------------------------------------</span><br><span class="line"></span><br><span class="line"> OSPF Process <span class="number">2</span> <span class="keyword">with</span> Router ID <span class="number">192.168</span><span class="number">.14</span><span class="number">.1</span></span><br><span class="line">  Peer Statistic Information</span><br><span class="line"> ----------------------------------------------------------------------------</span><br><span class="line"> Area Id          Interface                        Neighbor id      State    </span><br><span class="line"> <span class="number">0.0</span><span class="number">.0</span><span class="number">.0</span>          GigabitEthernet0/<span class="number">0</span>/<span class="number">1</span>             <span class="number">192.168</span><span class="number">.10</span><span class="number">.253</span>   Full        </span><br><span class="line"> ----------------------------------------------------------------------------</span><br><span class="line">[R1]</span><br><span class="line"></span><br><span class="line">#两个OSFP的邻接状态都建立成功了</span><br></pre></td></tr></table></figure></li><li><p>查看R1上的ospf vpnv4的路由表：</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line">[R1]dis ip routing-table vpn-instance <span class="number">1</span> protocol ospf </span><br><span class="line">Route Flags: R - relay, D - download to fib</span><br><span class="line">------------------------------------------------------------------------------</span><br><span class="line"><span class="number">1</span> routing table : OSPF</span><br><span class="line">         Destinations : <span class="number">5</span>        Routes : <span class="number">5</span>        </span><br><span class="line"></span><br><span class="line">OSPF routing table status : &lt;Active&gt;</span><br><span class="line">         Destinations : 5        Routes : 5</span><br><span class="line"></span><br><span class="line">Destination/Mask    Proto   Pre  Cost      Flags NextHop         Interface</span><br><span class="line"></span><br><span class="line">   192.168.10.0/24  OSPF    10   2           D   192.168.13.3    GigabitEthernet</span><br><span class="line">0/0/0</span><br><span class="line"> 192.168.10.254/32  OSPF    10   2           D   192.168.13.3    GigabitEthernet</span><br><span class="line">0/0/0</span><br><span class="line">   192.168.14.0/24  OSPF    10   3           D   192.168.13.3    GigabitEthernet</span><br><span class="line">0/0/0</span><br><span class="line">   192.168.20.0/24  OSPF    10   2           D   192.168.13.3    GigabitEthernet</span><br><span class="line">0/0/0</span><br><span class="line"> 192.168.20.254/32  OSPF    10   3           D   192.168.13.3    GigabitEthernet</span><br><span class="line">0/0/0</span><br><span class="line"></span><br><span class="line">OSPF routing table status : &lt;Inactive&gt;</span><br><span class="line">         Destinations : 0        Routes : 0</span><br><span class="line"></span><br><span class="line">[R1]</span><br><span class="line"></span><br><span class="line">#发现已经有了总公司主机的路由，但是BGP里面不存在，所以我么要将其引入进BGP，让他传递给分公司，</span><br></pre></td></tr></table></figure><ol start="15"><li>在PE-R1上做单点双向路由引入：</li></ol><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//在BGP 里面引入OSPF:</span></span><br><span class="line">[R1-bgp]ipv4-family vpn-instance <span class="number">1</span></span><br><span class="line">[R1-bgp<span class="number">-1</span>]<span class="keyword">import</span>-route ospf <span class="number">1</span> </span><br><span class="line"></span><br><span class="line">[R1-bgp]ipv4-family vpn-instance <span class="number">2</span></span><br><span class="line">[R1-bgp<span class="number">-2</span>]<span class="keyword">import</span>-route ospf <span class="number">2</span></span><br><span class="line"></span><br><span class="line"><span class="comment">//在ospf里面引入BGP:</span></span><br><span class="line">[R1]ospf <span class="number">1</span> </span><br><span class="line">[R1-ospf<span class="number">-1</span>]<span class="keyword">import</span>-route bgp</span><br><span class="line">[R1]ospf <span class="number">2</span> </span><br><span class="line">[R1-ospf<span class="number">-2</span>]<span class="keyword">import</span>-route bgp</span><br><span class="line"></span><br><span class="line"><span class="comment">//在BGP 里面引入OSPF:</span></span><br><span class="line">[R4-bgp]ipv4-family vpn-instance <span class="number">1</span></span><br><span class="line">[R4-bgp<span class="number">-1</span>]<span class="keyword">import</span>-route ospf <span class="number">200</span></span><br><span class="line"></span><br><span class="line"><span class="comment">//在ospf里面引入BGP:</span></span><br><span class="line">[R4]ospf <span class="number">200</span></span><br><span class="line">[R4-ospf<span class="number">-200</span>]<span class="keyword">import</span>-route bgp</span><br></pre></td></tr></table></figure><ol start="16"><li>查看PE的vpnv4 实例1的路由表：</li></ol><figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">[R1]dis ip rou vpn <span class="number">1</span> <span class="number">192.168</span><span class="number">.78</span><span class="number">.0</span> verbose</span><br><span class="line">Route Flags: R - relay, D - download to fib</span><br><span class="line">------------------------------------------------------------------------------</span><br><span class="line">Routing Table : <span class="number">1</span></span><br><span class="line">Summary Count : <span class="number">1</span></span><br><span class="line"></span><br><span class="line">Destination: <span class="number">192.168</span><span class="number">.78</span><span class="number">.0</span>/<span class="number">24</span></span><br><span class="line">     Protocol: IBGP             Process ID: <span class="number">0</span></span><br><span class="line">   Preference: <span class="number">255</span>                    Cost: <span class="number">4</span></span><br><span class="line">      NextHop: <span class="number">4.4</span><span class="number">.4</span><span class="number">.4</span>           Neighbour: <span class="number">4.4</span><span class="number">.4</span><span class="number">.4</span></span><br><span class="line">        State: Active Adv Relied       Age: <span class="number">00</span>h00m58s</span><br><span class="line">          Tag: <span class="number">0</span>                  Priority: low</span><br><span class="line">        Label: <span class="number">1040</span>                QoSInfo: <span class="number">0x0</span></span><br><span class="line">   IndirectID: <span class="number">0x4</span>              </span><br><span class="line"> RelayNextHop: <span class="number">10.1</span><span class="number">.12</span><span class="number">.2</span>         Interface: GigabitEthernet0/<span class="number">0</span>/<span class="number">2</span></span><br><span class="line">     TunnelID: <span class="number">0x3</span>                   Flags: RD</span><br><span class="line">[R1]</span><br><span class="line"></span><br><span class="line">#发现已经有了分公司二的主机路由了，私网标签为1040，这是由BGP分发的，</span><br><span class="line">#私网标签的作用是用于判断数据包通过哪个VPN实例进行转发。</span><br></pre></td></tr></table></figure><ol start="17"><li>查看MPLS LSP ：</li></ol><figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">[R4]dis mpls lsp include <span class="number">3.3</span><span class="number">.3</span><span class="number">.3</span> <span class="number">32</span></span><br><span class="line">-------------------------------------------------------------------------------</span><br><span class="line">                 LSP Information: LDP LSP</span><br><span class="line">-------------------------------------------------------------------------------</span><br><span class="line">FEC                In/Out Label  In/Out IF                      Vrf Name       </span><br><span class="line"><span class="number">3.3</span><span class="number">.3</span><span class="number">.3</span>/<span class="number">32</span>         NULL/<span class="number">3</span>        -<span class="regexp">/GE0/</span><span class="number">0</span>/<span class="number">1</span>                                     </span><br><span class="line"><span class="number">3.3</span><span class="number">.3</span><span class="number">.3</span>/<span class="number">32</span>         <span class="number">1024</span>/<span class="number">3</span>        -<span class="regexp">/GE0/</span><span class="number">0</span>/<span class="number">1</span>                                     </span><br><span class="line">[R4]</span><br><span class="line"></span><br><span class="line">#发现由MPLS LDP分配的公网标签为1024，</span><br><span class="line">#公网标签的作用是由于骨干网中没有vpnv4的路由表，指导不了vpnv4的路由转发，所以由公网标签进行指导转发，指导该数据包去往对端PE.</span><br></pre></td></tr></table></figure></li><li><p>抓包查看标签：</p><p><img src="/2019/05/10/HCIP综合实验/E:/MD保存文件\1556355743099.png" alt="1556355743099"></p><blockquote><p>发现公网标签为1024，私网标签为1040，跟上述一致</p></blockquote><ol start="19"><li>查看PE的vpnv4 实例2的路由表：</li></ol><figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">[R1]dis ip routing-table vpn-instance <span class="number">2</span> <span class="number">192.168</span><span class="number">.56</span><span class="number">.0</span> verbose </span><br><span class="line">Route Flags: R - relay, D - download to fib</span><br><span class="line">------------------------------------------------------------------------------</span><br><span class="line">Routing Table : <span class="number">2</span></span><br><span class="line">Summary Count : <span class="number">1</span></span><br><span class="line"></span><br><span class="line">Destination: <span class="number">192.168</span><span class="number">.56</span><span class="number">.0</span>/<span class="number">24</span></span><br><span class="line">     Protocol: IBGP             Process ID: <span class="number">0</span></span><br><span class="line">   Preference: <span class="number">255</span>                    Cost: <span class="number">0</span></span><br><span class="line">      NextHop: <span class="number">4.4</span><span class="number">.4</span><span class="number">.4</span>           Neighbour: <span class="number">4.4</span><span class="number">.4</span><span class="number">.4</span></span><br><span class="line">        State: Active Adv Relied       Age: <span class="number">03</span>h55m09s</span><br><span class="line">          Tag: <span class="number">0</span>                  Priority: low</span><br><span class="line">        Label: <span class="number">1027</span>                QoSInfo: <span class="number">0x0</span></span><br><span class="line">   IndirectID: <span class="number">0x3</span>              </span><br><span class="line"> RelayNextHop: <span class="number">10.1</span><span class="number">.12</span><span class="number">.2</span>         Interface: GigabitEthernet0/<span class="number">0</span>/<span class="number">2</span></span><br><span class="line">     TunnelID: <span class="number">0x3</span>                   Flags: RD</span><br><span class="line">[R1]</span><br><span class="line"></span><br><span class="line">#私网标签为1027</span><br><span class="line">#公网标签是一样的。因为数据都要达到R4</span><br></pre></td></tr></table></figure></li><li><p>抓包查看：</p><p><img src="/2019/05/10/HCIP综合实验/E:/MD保存文件\1556356419553.png" alt="1556356419553"></p><blockquote><p>公网你标签为1024，私网标签为1027.</p></blockquote></li></ol></li></ul><h3 id="实验结果："><a href="#实验结果：" class="headerlink" title="实验结果："></a>实验结果：</h3><ul><li><p>在总公司PC1上访问分公司PC 7:</p><ul><li><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">PC&gt;ping 192.168.78.7</span><br><span class="line"></span><br><span class="line">Ping 192.168.78.7: 32 data bytes, Press Ctrl_C to break</span><br><span class="line">From 192.168.78.7: bytes=32 seq=1 ttl=122 time=141 ms</span><br><span class="line">From 192.168.78.7: bytes=32 seq=2 ttl=122 time=140 ms</span><br><span class="line">From 192.168.78.7: bytes=32 seq=3 ttl=122 time=94 ms</span><br><span class="line">From 192.168.78.7: bytes=32 seq=4 ttl=122 time=141 ms</span><br><span class="line">From 192.168.78.7: bytes=32 seq=5 ttl=122 time=94 ms</span><br><span class="line"></span><br><span class="line">--- 192.168.78.7 ping statistics ---</span><br><span class="line">  5 packet(s) transmitted</span><br><span class="line">  5 packet(s) received</span><br><span class="line">  0.00% packet loss</span><br><span class="line">  round-trip min/avg/max = 94/122/141 ms</span><br><span class="line"></span><br><span class="line">PC&gt;</span><br></pre></td></tr></table></figure></li></ul></li><li><p>在总公司PC 2上访问分公司PC 6:</p><ul><li><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">PC&gt;ping 192.168.56.6</span><br><span class="line"></span><br><span class="line">Ping 192.168.56.6: 32 data bytes, Press Ctrl_C to break</span><br><span class="line">Request timeout!</span><br><span class="line">From 192.168.56.6: bytes=32 seq=2 ttl=123 time=141 ms</span><br><span class="line">From 192.168.56.6: bytes=32 seq=3 ttl=123 time=125 ms</span><br><span class="line">From 192.168.56.6: bytes=32 seq=4 ttl=123 time=172 ms</span><br><span class="line">From 192.168.56.6: bytes=32 seq=5 ttl=123 time=172 ms</span><br><span class="line"></span><br><span class="line">--- 192.168.56.6 ping statistics ---</span><br><span class="line">  5 packet(s) transmitted</span><br><span class="line">  4 packet(s) received</span><br><span class="line">  20.00% packet loss</span><br><span class="line">  round-trip min/avg/max = 0/152/172 ms</span><br><span class="line"></span><br><span class="line">PC&gt;</span><br></pre></td></tr></table></figure></li></ul></li><li><p>在分公司二PC 7上访问分公司一PC 6：</p><ul><li><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">PC&gt;ping 192.168.78.7</span><br><span class="line"></span><br><span class="line">Ping 192.168.78.7: 32 data bytes, Press Ctrl_C to break</span><br><span class="line">Request timeout!</span><br><span class="line">Request timeout!</span><br><span class="line">Request timeout!</span><br><span class="line">Request timeout!</span><br><span class="line">Request timeout!</span><br><span class="line"></span><br><span class="line">--- 192.168.78.7 ping statistics ---</span><br><span class="line">  5 packet(s) transmitted</span><br><span class="line">  0 packet(s) received</span><br><span class="line">  100.00% packet loss</span><br><span class="line"></span><br><span class="line">PC&gt;</span><br></pre></td></tr></table></figure></li></ul></li></ul><h3 id="实验总结："><a href="#实验总结：" class="headerlink" title="实验总结："></a>实验总结：</h3><hr><blockquote><p>本次实验的话，考察了很多的知识点，最难的是MPLS-VPN,其他的地方没有特别难的，但是要注意细节，整个实验考察了IP 大部分知识点，但是最难的路由过滤和渗透没有考察，总体来说，配置特别繁琐，要注意细节，根据自己的经验，一步一步的来，基本就没什么问题了。</p></blockquote><p>​     </p><p>​     </p>]]></content>
    
    <summary type="html">
    
      
      
        &lt;h1 id=&quot;HCIP综合实验：&quot;&gt;&lt;a href=&quot;#HCIP综合实验：&quot; class=&quot;headerlink&quot; title=&quot;HCIP综合实验：&quot;&gt;&lt;/a&gt;HCIP综合实验：&lt;/h1&gt;&lt;h3 id=&quot;实验拓扑：&quot;&gt;&lt;a href=&quot;#实验拓扑：&quot; class=&quot;header
      
    
    </summary>
    
      <category term="HCIP-R&amp;S 实验" scheme="http://yoursite.com/categories/HCIP-R-S-%E5%AE%9E%E9%AA%8C/"/>
    
    
      <category term="HCIP" scheme="http://yoursite.com/tags/HCIP/"/>
    
  </entry>
  
  <entry>
    <title>双点双向引入带来的次优路径和环路问题：</title>
    <link href="http://yoursite.com/2019/05/10/%E5%88%A9%E7%94%A8%E8%B7%AF%E7%94%B1%E7%AD%96%E7%95%A5%E8%A7%A3%E5%86%B3%E8%B7%AF%E7%94%B1%E5%8F%8C%E5%90%91%E5%BC%95%E5%85%A5%E4%B8%AD%E4%BA%A7%E7%94%9F%E7%9A%84%E8%B7%AF%E7%94%B1%E7%8E%AF%E8%B7%AF%E5%92%8C%E6%AC%A1%E4%BC%98%E8%B7%AF%E5%BE%84%E9%97%AE%E9%A2%98/"/>
    <id>http://yoursite.com/2019/05/10/利用路由策略解决路由双向引入中产生的路由环路和次优路径问题/</id>
    <published>2019-05-10T04:12:57.000Z</published>
    <updated>2019-05-10T16:42:57.427Z</updated>
    
    <content type="html"><![CDATA[<h1 id="双点双向引入带来的次优路劲和环路问题："><a href="#双点双向引入带来的次优路劲和环路问题：" class="headerlink" title="双点双向引入带来的次优路劲和环路问题："></a>双点双向引入带来的次优路劲和环路问题：</h1><h3 id="实验拓扑："><a href="#实验拓扑：" class="headerlink" title="实验拓扑："></a>实验拓扑：</h3><p><img src="https://img-blog.csdnimg.cn/20190403220824877.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3dlaXhpbl80Mzk0MTE4Mg==,size_16,color_FFFFFF,t_70" alt="在这里插入图片描述"></p><h3 id="拓扑描述："><a href="#拓扑描述：" class="headerlink" title="拓扑描述："></a>拓扑描述：</h3><ul><li>R1,R2之间运行静态，R2,R3,R4运行OSPF，R3,R4,R5运行RIP</li></ul><h3 id="实验需求："><a href="#实验需求：" class="headerlink" title="实验需求："></a>实验需求：</h3><ol><li>在R2上利用前缀列表精确匹配环回口路由并引入至RIP</li><li>将R2上利用filter-policy将环回口引入至OSPF时，只允许OSPF域内学到双数路由</li><li>在R3,R4上进行双向路由重分发</li><li>在R3,R4上对10.0.X.0/24进行自动汇总，请请避免环路</li></ol><h3 id="实验步骤："><a href="#实验步骤：" class="headerlink" title="实验步骤："></a>实验步骤：</h3><ul><li><p>配置IP地址，ping直连检验连通性（略）</p></li><li><p>配置OSPF(取R2配置)</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">[R2]ospf 1 router-id 2.2.2.2</span><br><span class="line">[R2-ospf-1]area 0</span><br><span class="line">[R2-ospf-1-area-0.0.0.0]network 2.2.2.2 0.0.0.0 </span><br><span class="line">[R2-ospf-1-area-0.0.0.0]network 10.0.23.2 0.0.0.0 </span><br><span class="line">[R2-ospf-1-area-0.0.0.0]network 10.0.24.2 0.0.0.0</span><br></pre></td></tr></table></figure></li><li><p>查看R2的ospf邻居表：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">[R2]dis ospf peer brief </span><br><span class="line"></span><br><span class="line"> OSPF Process 1 with Router ID 2.2.2.2</span><br><span class="line">  Peer Statistic Information</span><br><span class="line"> ----------------------------------------------------------------------------</span><br><span class="line"> Area Id          Interface                        Neighbor id      State    </span><br><span class="line"> 0.0.0.0          GigabitEthernet0/0/1             10.0.23.3        Full        </span><br><span class="line"> 0.0.0.0          GigabitEthernet0/0/2             4.4.4.4          Full        </span><br><span class="line"> ----------------------------------------------------------------------------</span><br><span class="line">[R2]</span><br><span class="line"></span><br><span class="line">#状态为full，邻接关系建立成功</span><br></pre></td></tr></table></figure></li><li><p>配置RIP（取R5配置）：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">[R5]rip 1</span><br><span class="line">[R5-rip-1]undo summary </span><br><span class="line">[R5-rip-1]version 2</span><br><span class="line">[R5-rip-1]network 10.0.0.0</span><br></pre></td></tr></table></figure></li><li><p>查看R5的RIP邻居表</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">[R5]dis rip 1 neighbor </span><br><span class="line">---------------------------------------------------------------------</span><br><span class="line"> IP Address      Interface                   Type   Last-Heard-Time</span><br><span class="line">---------------------------------------------------------------------</span><br><span class="line"> 10.0.35.3       GigabitEthernet0/0/0        RIP    0:0:20</span><br><span class="line"> Number of RIP routes  : 1</span><br><span class="line"> 10.0.45.4       GigabitEthernet0/0/1        RIP    0:0:21</span><br><span class="line"> Number of RIP routes  : 1</span><br><span class="line">[R5]</span><br><span class="line"></span><br><span class="line">#rip邻居建立成功。</span><br></pre></td></tr></table></figure></li><li><p>在R5上配置前缀列表精确引入外部路由：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">[R5]ip ip-prefix 1 index 10 permit 20.0.0.0 22 greater-equal 22 less-equal 24</span><br><span class="line"> --匹配前缀为20.0.0.0/22 中掩码为22-24中的四个网段</span><br><span class="line"> </span><br><span class="line">#我们这一下子匹配了四个，跟题目要求的不符合，往下看</span><br></pre></td></tr></table></figure></li><li><p>在在R5上配置两个环回口地址为20.0.3.1，20.0.4.1后，查看R4 RIP路由表</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">[R4]dis ip routing-table protocol rip </span><br><span class="line">Route Flags: R - relay, D - download to fib</span><br><span class="line">------------------------------------------------------------------------------</span><br><span class="line">Public routing table : RIP</span><br><span class="line">         Destinations : 6        Routes : 6        </span><br><span class="line"></span><br><span class="line">RIP routing table status : &lt;Active&gt;</span><br><span class="line">         Destinations : 5        Routes : 5</span><br><span class="line"></span><br><span class="line">Destination/Mask    Proto   Pre  Cost      Flags NextHop         Interface</span><br><span class="line"></span><br><span class="line">      10.0.35.0/24  RIP     100  1           D   10.0.45.5       GigabitEthernet</span><br><span class="line">0/0/1</span><br><span class="line">       20.0.0.0/24  RIP     100  1           D   10.0.45.5       GigabitEthernet</span><br><span class="line">0/0/1</span><br><span class="line">       20.0.1.0/24  RIP     100  1           D   10.0.45.5       GigabitEthernet</span><br><span class="line">0/0/1</span><br><span class="line">       20.0.2.0/24  RIP     100  1           D   10.0.45.5       GigabitEthernet</span><br><span class="line">0/0/1</span><br><span class="line">       20.0.3.0/24  RIP     100  1           D   10.0.45.5       GigabitEthernet</span><br><span class="line">0/0/1</span><br><span class="line"></span><br><span class="line">#发现新加的路由只有20.0.3.0被学习了，20.0.4.0没有被学习，起到一个过滤的作用</span><br><span class="line">#但是依旧会学到一条，那这不是就没有进行精确引入了吗？</span><br><span class="line">#可以在添加一条规则直接拒绝掉。</span><br></pre></td></tr></table></figure></li><li><p>在R5的前缀列表上新加入一条匹配规则：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">[R5]ip ip-prefix 1 index 5 deny 20.0.3.0 24 </span><br><span class="line"></span><br><span class="line"># 这条规则跟acl的匹配差不多，但是要注意index的值，让它优先进行匹配才能过滤。</span><br></pre></td></tr></table></figure></li><li><p>再次查看R4 RIP路由表：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">[R4]dis ip rou protocol rip </span><br><span class="line">Route Flags: R - relay, D - download to fib</span><br><span class="line">------------------------------------------------------------------------------</span><br><span class="line">Public routing table : RIP</span><br><span class="line">         Destinations : 5        Routes : 5        </span><br><span class="line"></span><br><span class="line">RIP routing table status : &lt;Active&gt;</span><br><span class="line">         Destinations : 4        Routes : 4</span><br><span class="line"></span><br><span class="line">Destination/Mask    Proto   Pre  Cost      Flags NextHop         Interface</span><br><span class="line"></span><br><span class="line">      10.0.35.0/24  RIP     100  1           D   10.0.45.5       GigabitEthernet</span><br><span class="line">0/0/1</span><br><span class="line">       20.0.0.0/24  RIP     100  1           D   10.0.45.5       GigabitEthernet</span><br><span class="line">0/0/1</span><br><span class="line">       20.0.1.0/24  RIP     100  1           D   10.0.45.5       GigabitEthernet</span><br><span class="line">0/0/1</span><br><span class="line">       20.0.2.0/24  RIP     100  1           D   10.0.45.5       GigabitEthernet</span><br><span class="line">0/0/1</span><br><span class="line"></span><br><span class="line">#精确引入要求达成</span><br></pre></td></tr></table></figure></li><li><p>在R1配置默认路由指向R2,在R2上配置静态并引入至OSPF域内：(略)</p></li></ul><ul><li><p>在R2上配置路由策略，只允许OSPF域内学到双数路由：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">[R2]acl 2000</span><br><span class="line">[R2-acl-basic-2000]rule 5 permit source 172.16.0.0 0.0.2.0 --配置ACL匹配172.16.0.0里面的双数网段</span><br><span class="line">[R2-ospf-1]filter-policy 2000 export static 按照过滤策略对引入静态路由在发布时进行过滤</span><br></pre></td></tr></table></figure></li><li><p>在R4上查看OSPF路由表：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line">[R4]dis ip rou pr osfp </span><br><span class="line">                  ^</span><br><span class="line">Error: Unrecognized command found at &apos;^&apos; position.</span><br><span class="line">[R4]dis ip rou pr ospf </span><br><span class="line">Route Flags: R - relay, D - download to fib</span><br><span class="line">------------------------------------------------------------------------------</span><br><span class="line">Public routing table : OSPF</span><br><span class="line">         Destinations : 5        Routes : 5        </span><br><span class="line"></span><br><span class="line">OSPF routing table status : &lt;Active&gt;</span><br><span class="line">         Destinations : 5        Routes : 5</span><br><span class="line"></span><br><span class="line">Destination/Mask    Proto   Pre  Cost      Flags NextHop         Interface</span><br><span class="line"></span><br><span class="line">        2.2.2.2/32  OSPF    10   1           D   10.0.24.2       GigabitEthernet</span><br><span class="line">0/0/0</span><br><span class="line">        3.3.3.3/32  OSPF    10   2           D   10.0.24.2       GigabitEthernet</span><br><span class="line">0/0/0</span><br><span class="line">      10.0.23.0/24  OSPF    10   2           D   10.0.24.2       GigabitEthernet</span><br><span class="line">0/0/0</span><br><span class="line">     172.16.0.0/24  O_ASE   150  1           D   10.0.24.2       GigabitEthernet</span><br><span class="line">0/0/0</span><br><span class="line">     172.16.2.0/24  O_ASE   150  1           D   10.0.24.2       GigabitEthernet</span><br><span class="line">0/0/0</span><br><span class="line"></span><br><span class="line">OSPF routing table status : &lt;Inactive&gt;</span><br><span class="line">         Destinations : 0        Routes : 0</span><br><span class="line"></span><br><span class="line">#发现只有两条双数路由的存在，要求达成</span><br></pre></td></tr></table></figure></li><li><p>在R3，R4上进行双向引入：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">[R3-ospf-1]import-route rip </span><br><span class="line">[R3-rip-1]import-route ospf</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">[R4-ospf-1]import-route rip </span><br><span class="line">[R4-rip-1]import-route ospf</span><br></pre></td></tr></table></figure></li><li><p>在R3上 tracert 172.16.0.0/172.16.2.0</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line">[R3]tracert 172.16.0.1</span><br><span class="line"></span><br><span class="line"> traceroute to  172.16.0.1(172.16.0.1), max hops: 30 ,packet length: 40,press CT</span><br><span class="line">RL_C to break </span><br><span class="line"></span><br><span class="line"> 1 10.0.35.5 40 ms  20 ms  20 ms </span><br><span class="line"></span><br><span class="line"> 2 10.0.45.4 20 ms  20 ms  20 ms </span><br><span class="line"></span><br><span class="line"> 3 10.0.24.2 30 ms  20 ms  20 ms </span><br><span class="line"></span><br><span class="line"> 4 10.0.12.1 40 ms  40 ms  40 ms </span><br><span class="line">[R3]</span><br><span class="line"></span><br><span class="line">&lt;R3&gt;tracert 172.16.2.1</span><br><span class="line"></span><br><span class="line"> traceroute to  172.16.2.1(172.16.2.1), max hops: 30 ,packet length: 40,press CT</span><br><span class="line">RL_C to break </span><br><span class="line"></span><br><span class="line"> 1 10.0.35.5 10 ms  10 ms  10 ms </span><br><span class="line"></span><br><span class="line"> 2 10.0.45.4 20 ms  20 ms  20 ms </span><br><span class="line"></span><br><span class="line"> 3 10.0.24.2 40 ms  30 ms  30 ms </span><br><span class="line"></span><br><span class="line"> 4 10.0.12.1 40 ms  30 ms  40 ms </span><br><span class="line">&lt;R3&gt;</span><br><span class="line"></span><br><span class="line">#发现通往次网段的路径都是R5-R4-R2-R1,而这个路径不是最优的，所以当我们进行双向引入的时候，造成了次优路径的产生，</span><br><span class="line">#因为OSPF外部路由优先级为150，在R4上将OSPF重发布进RIP后，R5会学到此路由，并且会发给R3,此时R3上就会存在两条路由，因为rip优先级为100，比外部路由的小，所以优先选择RIP的，因此造成次优路劲。</span><br><span class="line">#关于次优路径，有两种解决办法：</span><br><span class="line">#结局方案一：首先是在R2上将外部路由的优先级直接改为比100小，</span><br><span class="line">#解决方案二：还有就是将OSPF路由引入RIP后，将优先级改的比150大</span><br><span class="line">#两种办法我们都尝试一下</span><br></pre></td></tr></table></figure></li><li><p>解决方案1：在R4上修改外部网络的优先级为99：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">[R4]acl 2000</span><br><span class="line">[R4-acl-basic-2000]rule 5 permit source 172.16.0.0 0.0.2.0 </span><br><span class="line">[R4]route-policy ase permit node 10  --配置route-policy的名字和进程</span><br><span class="line">[R4-route-policy]if-match acl 2000  --匹配acl 2000</span><br><span class="line">[R4-route-policy]apply preference 99 --定义动作为优先级99.</span><br><span class="line">[R4-ospf-1]preference ase route-policy ase --配置路由策略为特定的路由设定优先级</span><br></pre></td></tr></table></figure></li><li><p>查看R4的路由表：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line">[R4]dis ip routing-table protocol ospf </span><br><span class="line">Route Flags: R - relay, D - download to fib</span><br><span class="line">------------------------------------------------------------------------------</span><br><span class="line">Public routing table : OSPF</span><br><span class="line">         Destinations : 5        Routes : 5        </span><br><span class="line"></span><br><span class="line">OSPF routing table status : &lt;Active&gt;</span><br><span class="line">         Destinations : 5        Routes : 5</span><br><span class="line"></span><br><span class="line">Destination/Mask    Proto   Pre  Cost      Flags NextHop         Interface</span><br><span class="line"></span><br><span class="line">        2.2.2.2/32  OSPF    10   1           D   10.0.24.2       GigabitEthernet</span><br><span class="line">0/0/0</span><br><span class="line">        3.3.3.3/32  OSPF    10   2           D   10.0.24.2       GigabitEthernet</span><br><span class="line">0/0/0</span><br><span class="line">      10.0.23.0/24  OSPF    10   2           D   10.0.24.2       GigabitEthernet</span><br><span class="line">0/0/0</span><br><span class="line">     172.16.0.0/24  O_ASE   99   1           D   10.0.24.2       GigabitEthernet</span><br><span class="line">0/0/0</span><br><span class="line">     172.16.2.0/24  O_ASE   99   1           D   10.0.24.2       GigabitEthernet</span><br><span class="line">0/0/0</span><br><span class="line"></span><br><span class="line">OSPF routing table status : &lt;Inactive&gt;</span><br><span class="line">         Destinations : 0        Routes : 0</span><br><span class="line"></span><br><span class="line">[R4]</span><br><span class="line"></span><br><span class="line">#发现外部路由优先级为99，而rip的优先级为100，所以就不会从RIP中不会学到该路由。R4上的次优路径解除。</span><br><span class="line">#R3配置和R4同理</span><br></pre></td></tr></table></figure></li><li><p>解决方案2：在R2上面配置路由策略，将引入的外部路由打上tag 500的标签：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">[R2]route-policy tag permit node 10</span><br><span class="line">[R2-route-policy] apply tag 500  --打上tag500</span><br><span class="line">[R2-ospf-1]import-route static route-policy tag  --引入路由的时候调用路由策略</span><br></pre></td></tr></table></figure></li><li><p>在R4上配置路由策略对tag路由进行匹配，并在rip里面加上优先级。</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">[R4]route-policy 1 permit node 10</span><br><span class="line">[R4-route-policy]if-match tag 500  --匹配tag500的路由</span><br><span class="line">[R4-route-policy]apply preference 200  --定义动作，加上优先级为200</span><br><span class="line">[R4-rip-1]preference route-policy 1  --指定路由策略，对满足条件的特定路由设置优先级。</span><br></pre></td></tr></table></figure></li><li><p>查看R4的路由表：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br></pre></td><td class="code"><pre><span class="line">[R4]dis ip routing-table </span><br><span class="line">Route Flags: R - relay, D - download to fib</span><br><span class="line">------------------------------------------------------------------------------</span><br><span class="line">Routing Tables: Public</span><br><span class="line">         Destinations : 20       Routes : 20       </span><br><span class="line"></span><br><span class="line">Destination/Mask    Proto   Pre  Cost      Flags NextHop         Interface</span><br><span class="line"></span><br><span class="line">        2.2.2.2/32  OSPF    10   1           D   10.0.24.2       GigabitEthernet</span><br><span class="line">0/0/0</span><br><span class="line">        3.3.3.3/32  OSPF    10   2           D   10.0.24.2       GigabitEthernet</span><br><span class="line">0/0/0</span><br><span class="line">        4.4.4.4/32  Direct  0    0           D   127.0.0.1       LoopBack0</span><br><span class="line">      10.0.23.0/24  OSPF    10   2           D   10.0.24.2       GigabitEthernet</span><br><span class="line">0/0/0</span><br><span class="line">      10.0.24.0/24  Direct  0    0           D   10.0.24.4       GigabitEthernet</span><br><span class="line">0/0/0</span><br><span class="line">      10.0.24.4/32  Direct  0    0           D   127.0.0.1       GigabitEthernet</span><br><span class="line">0/0/0</span><br><span class="line">    10.0.24.255/32  Direct  0    0           D   127.0.0.1       GigabitEthernet</span><br><span class="line">0/0/0</span><br><span class="line">      10.0.35.0/24  RIP     100  1           D   10.0.45.5       GigabitEthernet</span><br><span class="line">0/0/1</span><br><span class="line">      10.0.45.0/24  Direct  0    0           D   10.0.45.4       GigabitEthernet</span><br><span class="line">0/0/1</span><br><span class="line">      10.0.45.4/32  Direct  0    0           D   127.0.0.1       GigabitEthernet</span><br><span class="line">0/0/1</span><br><span class="line">    10.0.45.255/32  Direct  0    0           D   127.0.0.1       GigabitEthernet</span><br><span class="line">0/0/1</span><br><span class="line">       20.0.0.0/24  RIP     100  1           D   10.0.45.5       GigabitEthernet</span><br><span class="line">0/0/1</span><br><span class="line">       20.0.1.0/24  RIP     100  1           D   10.0.45.5       GigabitEthernet</span><br><span class="line">0/0/1</span><br><span class="line">       20.0.2.0/24  RIP     100  1           D   10.0.45.5       GigabitEthernet</span><br><span class="line">0/0/1</span><br><span class="line">      127.0.0.0/8   Direct  0    0           D   127.0.0.1       InLoopBack0</span><br><span class="line">      127.0.0.1/32  Direct  0    0           D   127.0.0.1       InLoopBack0</span><br><span class="line">127.255.255.255/32  Direct  0    0           D   127.0.0.1       InLoopBack0</span><br><span class="line">     172.16.0.0/24  O_ASE   150  1           D   10.0.24.2       GigabitEthernet</span><br><span class="line">0/0/0</span><br><span class="line">     172.16.2.0/24  O_ASE   150  1           D   10.0.24.2       GigabitEthernet</span><br><span class="line">0/0/0</span><br><span class="line">255.255.255.255/32  Direct  0    0           D   127.0.0.1       InLoopBack0</span><br><span class="line"></span><br><span class="line">[R4] </span><br><span class="line"></span><br><span class="line">#发现在R4上访问外部路由的下一跳为R2,这时次优路径的问题就被解决了</span><br><span class="line">#因为172.16.0.0/172.16.2.0,在RIP内的优先级为200，所以优先选择OSPF区域内的，所以不存在次优问题了</span><br><span class="line">#R3配置和R4同理</span><br></pre></td></tr></table></figure></li><li><p>次优路径解决，但是因为是在R3,R4上做的双点双向路由重分发，所以在R3上rip从ospf学到的路由，可能会经过R4继续传给OSPF,这样会造成路由回灌，会产生环路。我们可以在R3上引入路由的时候打上一个tag标签，让路由带标签进行传递，然后在R4上拒绝该tag路由的传递，这样就避免了路由回灌。</p></li><li><p>在R3上配置单点双向的标签标记。</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">[R3]route-policy o2r permit node 10  </span><br><span class="line">[R3-route-policy]apply tag 100  --打上tag100</span><br><span class="line">[R3-rip-1]import-route ospf 1 route-policy o2r --引入的OSPF路由全都打上了tag100的标签。</span><br><span class="line"></span><br><span class="line">[R4]route-policy r2o deny node 10 </span><br><span class="line">[R4-route-policy]if-match tag 100  --匹配tag100</span><br><span class="line">[R4-ospf-1]import-route rip route-policy r2o --引入rip路由是拒绝tag100的路由</span><br><span class="line"></span><br><span class="line">[R3]route-policy r2o permit node 10  </span><br><span class="line">[R3-route-policy]apply tag 200</span><br><span class="line">[R3-ospf-1]import-route rip route-policy r2o </span><br><span class="line"></span><br><span class="line">[R4]route-policy o2r deny node 10</span><br><span class="line">[R4-route-policy]if-match tag 200</span><br><span class="line">[R4-rip-1]import-route ospf 1 route-policy o2r </span><br><span class="line"></span><br><span class="line">#o2r --OSPF引入RIP</span><br><span class="line">#r2o --rip引入OSPF.</span><br></pre></td></tr></table></figure></li><li><p>在R4上配置单点双向的标签标记。</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">[R4]route-policy o2r permit node 20</span><br><span class="line">[R4-route-policy]apply tag 300 </span><br><span class="line"></span><br><span class="line">[R3]route-policy r2o deny node 20</span><br><span class="line">[R3-route-policy]if-match tag 300</span><br><span class="line"></span><br><span class="line">[R4]route-policy r2o permit node 20</span><br><span class="line">[R4-route-policy]apply tag 400</span><br><span class="line"></span><br><span class="line">[R3]route-policy r2o deny node 20</span><br><span class="line">[R3-route-policy]if-match tag 400</span><br><span class="line"></span><br><span class="line">#因为刚才已经在引入时进行调用了，现在就不必调用了。</span><br></pre></td></tr></table></figure></li><li><p>配置路由汇总：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">[R3-ospf-1]asbr-summary 20.0.0.0 255.255.0.0</span><br><span class="line"></span><br><span class="line">[R4-ospf-1]asbr-summary 20.0.0.0 255.255.0.0</span><br></pre></td></tr></table></figure></li><li><p>查看R3的rip路由表：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line">[R3]dis ip routing-table protocol rip </span><br><span class="line">Route Flags: R - relay, D - download to fib</span><br><span class="line">------------------------------------------------------------------------------</span><br><span class="line">Public routing table : RIP</span><br><span class="line">         Destinations : 6        Routes : 6        </span><br><span class="line"></span><br><span class="line">RIP routing table status : &lt;Active&gt;</span><br><span class="line">         Destinations : 6        Routes : 6</span><br><span class="line"></span><br><span class="line">Destination/Mask    Proto   Pre  Cost      Flags NextHop         Interface</span><br><span class="line"></span><br><span class="line">        4.4.4.4/32  RIP     100  2           D   10.0.35.5       GigabitEthernet</span><br><span class="line">0/0/1</span><br><span class="line">      10.0.24.0/24  RIP     100  2           D   10.0.35.5       GigabitEthernet</span><br><span class="line">0/0/1</span><br><span class="line">      10.0.45.0/24  RIP     100  1           D   10.0.35.5       GigabitEthernet</span><br><span class="line">0/0/1</span><br><span class="line">       20.0.0.0/24  RIP     100  1           D   10.0.35.5       GigabitEthernet</span><br><span class="line">0/0/1</span><br><span class="line">       20.0.1.0/24  RIP     100  1           D   10.0.35.5       GigabitEthernet</span><br><span class="line">0/0/1</span><br><span class="line">       20.0.2.0/24  RIP     100  1           D   10.0.35.5       GigabitEthernet</span><br><span class="line">0/0/1</span><br><span class="line"></span><br><span class="line">RIP routing table status : &lt;Inactive&gt;</span><br><span class="line">         Destinations : 0        Routes : 0</span><br><span class="line"></span><br><span class="line">[R3]</span><br><span class="line"></span><br><span class="line">#发现有一条聚合路由20.0.0.0的存在，在R4的路由表中也会存在该路由</span><br><span class="line">#那么当访问一条不存在的20.0.x.x的路由时，在R3和R4之间就会产生环路。</span><br></pre></td></tr></table></figure></li><li><p>在R4上tracert 20.0.5.1</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">[R4]tracert 20.0.5.1</span><br><span class="line"></span><br><span class="line"> traceroute to  20.0.5.1(20.0.5.1), max hops: 30 ,packet length: 40,press CTRL_C</span><br><span class="line"> to break </span><br><span class="line"></span><br><span class="line"> 1 10.0.45.5 20 ms  20 ms  20 ms </span><br><span class="line"></span><br><span class="line"> 2 10.0.35.3 20 ms  20 ms  20 ms </span><br><span class="line"></span><br><span class="line"> 3 10.0.23.2 20 ms  20 ms  30 ms </span><br><span class="line"></span><br><span class="line"> 4 10.0.23.3 30 ms 10.0.24.4 20 ms 10.0.23.3 30 ms </span><br><span class="line"></span><br><span class="line"> 5 10.0.45.5 30 ms 10.0.23.2 30 ms 10.0.45.5 30 ms</span><br><span class="line"> </span><br><span class="line"> #当我们试图访问压根就不存在的路由时，会造成环路。</span><br><span class="line"> #可以通过在R3,R4配置acl，拒绝聚合路由的进入就可以了，因为在R3或者R4上访问该路由时，会以聚合路由的路由条目进行查表转发</span><br></pre></td></tr></table></figure></li><li><p>在R3配置acl拒绝聚合路由传递。</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">[R3]acl 2000</span><br><span class="line">[R3-acl-basic-2000]rule 5 deny source 20.0.0.0 0.0.255.255</span><br><span class="line">[R4-acl-basic-2000]rule 10 permit source any  --acl在进行路由过滤的话默认是拒绝所有的。</span><br><span class="line">[R3-acl-basic-2000]quit </span><br><span class="line"></span><br><span class="line">[R3-ospf-1]filter-policy 2000 import  --</span><br></pre></td></tr></table></figure></li><li><p>再次在R4 tracert 20.0.5.1</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">R4]tracert 20.0.5.1</span><br><span class="line"></span><br><span class="line"> traceroute to  20.0.5.1(20.0.5.1), max hops: 30 ,packet length: 40,press CTRL_C</span><br><span class="line"> to break </span><br><span class="line"></span><br><span class="line"> 1  *  *  * </span><br><span class="line"></span><br><span class="line"> 2  *  *  * </span><br><span class="line"></span><br><span class="line"> 3  *  *  *</span><br><span class="line"> </span><br><span class="line"> #已经访问不了，达成实验要求.</span><br></pre></td></tr></table></figure></li></ul><h3 id="实验结果："><a href="#实验结果：" class="headerlink" title="实验结果："></a>实验结果：</h3><ul><li><p>在R5上访问R1</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">[R5]ping 172.16.0.1</span><br><span class="line">  PING 172.16.0.1: 56  data bytes, press CTRL_C to break</span><br><span class="line">    Request time out</span><br><span class="line">    Reply from 172.16.0.1: bytes=56 Sequence=2 ttl=253 time=50 ms</span><br><span class="line">    Reply from 172.16.0.1: bytes=56 Sequence=3 ttl=253 time=30 ms</span><br><span class="line">    Reply from 172.16.0.1: bytes=56 Sequence=4 ttl=253 time=30 ms</span><br><span class="line">    Reply from 172.16.0.1: bytes=56 Sequence=5 ttl=253 time=20 ms</span><br><span class="line"></span><br><span class="line">  --- 172.16.0.1 ping statistics ---</span><br><span class="line">    5 packet(s) transmitted</span><br><span class="line">    4 packet(s) received</span><br><span class="line">    20.00% packet loss</span><br><span class="line">    round-trip min/avg/max = 20/32/50 ms</span><br><span class="line"></span><br><span class="line">[R5]</span><br><span class="line"></span><br><span class="line">#实验成功</span><br></pre></td></tr></table></figure></li></ul><h3 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h3><blockquote><p>本次实验主要考察对路由策略知识点，还有双点双向重分发遇到的问题，着重理解次优路径的产生，以及怎么解决次优路径，还有就是对于路由回灌的问题，不要对两边路由引入的方向绕晕。</p></blockquote>]]></content>
    
    <summary type="html">
    
      
      
        &lt;h1 id=&quot;双点双向引入带来的次优路劲和环路问题：&quot;&gt;&lt;a href=&quot;#双点双向引入带来的次优路劲和环路问题：&quot; class=&quot;headerlink&quot; title=&quot;双点双向引入带来的次优路劲和环路问题：&quot;&gt;&lt;/a&gt;双点双向引入带来的次优路劲和环路问题：&lt;/h1&gt;&lt;h3 i
      
    
    </summary>
    
      <category term="HCIP-R&amp;S 实验" scheme="http://yoursite.com/categories/HCIP-R-S-%E5%AE%9E%E9%AA%8C/"/>
    
    
      <category term="HCIP" scheme="http://yoursite.com/tags/HCIP/"/>
    
      <category term="双点双向" scheme="http://yoursite.com/tags/%E5%8F%8C%E7%82%B9%E5%8F%8C%E5%90%91/"/>
    
  </entry>
  
  <entry>
    <title>OSPF链路状态信息</title>
    <link href="http://yoursite.com/2019/05/10/OSPF%E9%93%BE%E8%B7%AF%E7%8A%B6%E6%80%81%E4%BF%A1%E6%81%AF/"/>
    <id>http://yoursite.com/2019/05/10/OSPF链路状态信息/</id>
    <published>2019-05-10T04:12:57.000Z</published>
    <updated>2019-05-10T16:56:35.702Z</updated>
    
    <content type="html"><![CDATA[<h1 id="OSPF链路状态信息"><a href="#OSPF链路状态信息" class="headerlink" title="OSPF链路状态信息"></a>OSPF链路状态信息</h1><h3 id="OSPF-LSA类型："><a href="#OSPF-LSA类型：" class="headerlink" title="OSPF LSA类型："></a>OSPF LSA类型：</h3><table><thead><tr><th style="text-align:center">LSA类型</th><th style="text-align:center">LSA作用</th></tr></thead><tbody><tr><td style="text-align:center">Router-LSA</td><td style="text-align:center">每个普通路由器都会产生，描述路由器的链路状态和开销，在发布路由器所属的区域内进行传播</td></tr><tr><td style="text-align:center">Network-LSA</td><td style="text-align:center">由DR设备产生，描述DR所在网络的链路信息，在DR所属的区域进行传播</td></tr><tr><td style="text-align:center">Network-summary-LSA</td><td style="text-align:center">由ABR产生，描述区域内某个网段的路由，并通告给发布或接受此LSA的区域。</td></tr><tr><td style="text-align:center">ASBR-summary-LSA</td><td style="text-align:center">由ABR产生，描述到ASBR的路径和开销，通告给除ASBR区域外的其他区域</td></tr><tr><td style="text-align:center">AS-external-LSA</td><td style="text-align:center">由ASBR产生，描述到AS外部路由，通告给出特殊区域以外的所有区域</td></tr><tr><td style="text-align:center">NSSA LSA</td><td style="text-align:center">由ASBR产生，描述到AS外部路由,仅在NSSA区域内传播。</td></tr></tbody></table><h3 id="Router-LSA定义的四种网络类型"><a href="#Router-LSA定义的四种网络类型" class="headerlink" title="Router-LSA定义的四种网络类型:"></a>Router-LSA定义的四种网络类型:</h3><table><thead><tr><th style="text-align:center">Type</th><th style="text-align:center">描述</th><th style="text-align:center">link id</th><th style="text-align:center">link data</th></tr></thead><tbody><tr><td style="text-align:center">P2P</td><td style="text-align:center">点到点</td><td style="text-align:center">自己的R-ID</td><td style="text-align:center">自己接口的ip地址</td></tr><tr><td style="text-align:center">Transnet</td><td style="text-align:center">广播</td><td style="text-align:center">DR的接口ip</td><td style="text-align:center">自己接口的ip地址</td></tr><tr><td style="text-align:center">stubnet</td><td style="text-align:center">环回口</td><td style="text-align:center">网络地址</td><td style="text-align:center">子网掩码</td></tr><tr><td style="text-align:center">virtual link</td><td style="text-align:center">虚链路</td><td style="text-align:center">vlink对端ABR的R-ID</td><td style="text-align:center">本地vlink的ip地址</td></tr></tbody></table><h3 id="OSPF-特殊区域："><a href="#OSPF-特殊区域：" class="headerlink" title="OSPF 特殊区域："></a>OSPF 特殊区域：</h3><table><thead><tr><th style="text-align:center">区域</th><th style="text-align:center">作用</th></tr></thead><tbody><tr><td style="text-align:center">STUB</td><td style="text-align:center">允许三类LSA以明细的形式存在进入本区域，拒绝外部路由信息的引入，</td></tr><tr><td style="text-align:center">完全STUB</td><td style="text-align:center">允许三类LSA以缺省的形式进入本区域，拒绝外部路由信息的引入</td></tr><tr><td style="text-align:center">NSSA</td><td style="text-align:center">允许三类LSA以明细的形式进入本区域，允许外部路由的引入，但是在本区域里面只能以7类LSA的形式存在，当想要访问区域外的外部路由时，会将外部路由的5类LSA转换为7类缺省的LSA（默认情况下会改变adv ）.当区域外想访问本区域外部路由时，需要将7类LSA转换为5类明细的LSA.</td></tr><tr><td style="text-align:center">完全NSSA区域</td><td style="text-align:center">允许三类LSA以缺省的形式进入本区域，其他的跟NSSA完全相同。</td></tr></tbody></table><h3 id="OSPF虚连接："><a href="#OSPF虚连接：" class="headerlink" title="OSPF虚连接："></a>OSPF虚连接：</h3><h4 id="虚连接特点："><a href="#虚连接特点：" class="headerlink" title="虚连接特点："></a>虚连接特点：</h4><ol><li><p>虚链路永远属于区域0</p></li><li><p>虚链路通过单播的方式发送报文，TTL为255</p></li><li><p>虚链路只能配置在普通区域</p></li><li><p>虚链路只能在同一区域建立，不能跨区域建立</p></li><li><p>虚链路配置是需要指定邻居的R-ID，通过两次SPF算法确定目标地址和源地址，建立单播连接</p></li></ol><h4 id="虚连接有那些问题？"><a href="#虚连接有那些问题？" class="headerlink" title="虚连接有那些问题？"></a>虚连接有那些问题？</h4><ol><li>虚链路不能针对来自区域0的路由条目做汇总</li><li>虚链路会引发环路问题</li><li>R-ID冲突或者修改R-ID会造成虚链路不稳定</li><li>只传递LSA,不传递数据</li></ol><h4 id="虚连接的应用场景："><a href="#虚连接的应用场景：" class="headerlink" title="虚连接的应用场景："></a>虚连接的应用场景：</h4><ul><li>骨干区域被分割</li><li>非骨干区域没有与骨干区域相连</li><li>没有骨干区域的存在</li><li>避免次优路径的产生<ul><li>如果在ospf中通过不同类型的路由收到同一条路由：1,2类&gt;3类&gt;4,5类。</li></ul></li></ul><h3 id="OSPF防环机制："><a href="#OSPF防环机制：" class="headerlink" title="OSPF防环机制："></a>OSPF防环机制：</h3><ul><li>区域内：通过router-lsa，network-lsa进行SPF算法，算出一颗最短路径树，在计算的过程中，就已经消除了环路</li><li>区域间：<ul><li>Summary-LSA的防环机制：ABR接受非骨干区域的summary-lsa，但是不用来做路由计算，</li><li>ABR为某一区域产生三类LSA之后，不会再将该LSA传回源区域。</li></ul></li><li>区域外：<ul><li>五类LSA的防环机制，要看FA字段是否为0，</li><li>FA字段为0，参考三类LSA防环</li><li>FA字段非0，参考四类LSA防环</li></ul></li><li>如果在ospf中通过不同路由的类型收到同一条路由：1,2类&gt;3类&gt;4,5类。</li></ul><h3 id="外部路由的类型："><a href="#外部路由的类型：" class="headerlink" title="外部路由的类型："></a>外部路由的类型：</h3><ul><li>ospf引入外部路由开销都为1 ，默认类型type2</li><li>type1 ：内部+外部开销</li><li>type2：先比较外部开销再比较内部开销</li><li>type1&gt;type2</li></ul><h3 id="Forawrding-address作用："><a href="#Forawrding-address作用：" class="headerlink" title="Forawrding-address作用："></a>Forawrding-address作用：</h3><ul><li>仅出现在5类lsa，7类lsa中，</li><li>他是数据包访问外部网络时，在数据报文离开OSPF域时的下一跳地址。</li><li>FA指导非ASBR区域如果访问外部路由，同时可以避免次优路劲。</li><li>FA为0时，要通过ASBR访问外部，靠一类/二类LSA到达ABR,靠四类LSA到达ASBR,</li><li>FA非0时：不需要通过ASBR访问外部，靠一类/二类LSA达到ABR,靠三类LSA到达FA地址。</li><li>ASBR上的接口如果满足一下四个条件，ASBR到达外部路由的下一跳地址就是FA的地址。：<ol><li>直连接口所在网段发布到了ospf</li><li>接口不是静默接口    </li><li>接口网络类型不是p2p</li><li>接口网络类型不是p2mp</li></ol></li><li>如果FA非0，要判断FA地址是否可达，若不可达，则该外部路由不进入此路由表。</li><li>7类LSA FA为0时，7类LSA是不会向外传递的，</li><li>7类LSA FA非0时，看是否满足如上四条规则，满足的话，FA就是ASBR上外部路由的下一跳地址，不满足的话，FA就只会是ASBR上的环回口地址或者物理接口地址，优先选择环回口。</li></ul><h3 id="7类LSA和5类LSA的相同点-不同点："><a href="#7类LSA和5类LSA的相同点-不同点：" class="headerlink" title="7类LSA和5类LSA的相同点/不同点："></a>7类LSA和5类LSA的相同点/不同点：</h3><ul><li>相同点：<ul><li>相同的格式，相同的作用：</li></ul></li><li>不同点：<ul><li>LSA7仅在NSSA区域泛洪</li><li>7类LSA FA为0时，7类LSA是不会向外传递的</li><li>外部路由在NSSA区域里以7类LSA传递,在其他区域里以5类LSA传递，在ABR上做转换。</li><li>7类LSA以 option字段 P 置位来判断是否进行转换，</li><li>默认情况下，转换路由器是NSSA区域中R-ID最大的ABRS路由器。</li><li>在ABR上引入外部路由，产生的7类LSA option P不会置位。</li></ul></li></ul>]]></content>
    
    <summary type="html">
    
      
      
        &lt;h1 id=&quot;OSPF链路状态信息&quot;&gt;&lt;a href=&quot;#OSPF链路状态信息&quot; class=&quot;headerlink&quot; title=&quot;OSPF链路状态信息&quot;&gt;&lt;/a&gt;OSPF链路状态信息&lt;/h1&gt;&lt;h3 id=&quot;OSPF-LSA类型：&quot;&gt;&lt;a href=&quot;#OSPF-LSA类型
      
    
    </summary>
    
      <category term="HCIP-R&amp;S 笔记" scheme="http://yoursite.com/categories/HCIP-R-S-%E7%AC%94%E8%AE%B0/"/>
    
    
      <category term="HCIP" scheme="http://yoursite.com/tags/HCIP/"/>
    
      <category term="OSPF" scheme="http://yoursite.com/tags/OSPF/"/>
    
  </entry>
  
  <entry>
    <title>PIM-DM路由协议</title>
    <link href="http://yoursite.com/2019/05/10/Pim-DM/"/>
    <id>http://yoursite.com/2019/05/10/Pim-DM/</id>
    <published>2019-05-10T04:12:57.000Z</published>
    <updated>2019-05-10T16:55:10.213Z</updated>
    
    <content type="html"><![CDATA[<h1 id="PIM路由协议基础："><a href="#PIM路由协议基础：" class="headerlink" title="PIM路由协议基础："></a>PIM路由协议基础：</h1><h3 id="PIM-DM的工作机制："><a href="#PIM-DM的工作机制：" class="headerlink" title="PIM-DM的工作机制："></a>PIM-DM的工作机制：</h3><ul><li><p>邻居发现：</p><ul><li><p>pim路由器会像目的地址为224.0.0.13发送hello来建立邻居关系，TTL值为1</p></li><li><p>==目的地址224.0.0.13标识区域内的所有pim路由器，为什么采用组播地址，因为不一定是只跟一台路由器建立邻居关系==</p></li><li><p>pim邻居建立过程中，会通过hello报文协商option参数，pim协议支持各种选项参数。</p><p>| 选项id |     选项内容      |                     选项作用                     |<br>| :—-: | :—————: | :———————————————-: |<br>|   1    |  hello hold time  | 邻居关系的维持时间，默认为3.5倍的hello时间，105s |<br>|   2    |  Lan prune delay  |       发送prune的最大延时时间，默认为0.5s        |<br>|        | override-interval |    发送否决剪枝jion报文的时间间隔，默认为2.5s    |<br>|   19   |    DR priority    |  DR优先级，先比较优先级再比较接口ip地址，都比大  |<br>|        |   generation ID   |               跟踪邻居路由器的变化               |</p></li><li><p>==hello报文每30s发送一次，死亡时间是hello时间的3.5倍、105s==</p></li></ul></li><li><p>扩散：</p><ul><li>路由器收到组播报文，先进行RPF检查，然后向所有的pim邻居和IGMP接受者进行复制转发。</li><li>接受到组播报文的pim路由器会在本地创建相应的S G表项。</li><li>当扩散到叶子路由器，叶子路由器会判断是否有组播接受者，有的话，会创建相应的sg表项，没有的话，则向上游进行剪枝</li></ul></li><li><p>剪枝：</p><ul><li>在SG表项中，当下游接口列表为空，并有扩散的组播数据时，那么就会像上游的pim邻居组播发送剪枝报文（prune），目的地址为224.0.0.13，让他不要再发送组播报文过来，</li><li>pim邻居收到报文后，会将下游端口删除，并启动剪枝计时器（210s），那么自己的下游接口又为空，那么就又会向上游邻居发送剪枝报文，</li><li>join/prune报文中，P置位为1是剪枝报文，J置位为1是加入报文。</li></ul></li><li><p>剪枝延缓计时器：</p><ul><li>当收到下游发送的剪枝报文后，会根据邻居数量是否大于1来进行相应的处理，</li><li>只有一个邻居，收到剪枝报文后，立即将该接口变为剪枝状态</li><li>有多个邻居，收到剪枝报文后，会启动一个剪枝延时计时器==（3s=0.5+2.5）==，在这个时间内从其中一个邻居收到了一个join报文（2.5s），就会启动剪枝否决机制。</li><li>在下游接口有直连接受者，就不管了pim邻居的数量。</li><li>==pim prune的最大传输时间为0.5。==</li><li>==join报文发送的默认时间间隔为2.5s。==</li></ul></li><li><p>嫁接：</p><ul><li>当有一条新的主机想加入某个组播组，那么就会像上游的pim邻居单播发送graft嫁接报文，</li><li>发送graft报文，并启动嫁接定时器（3s），要求上游路由器主动将被剪除的接口添加到下游接口列表中，并向其转发组播数据</li><li>收到graft报文后，会回复一个graft ack报文来做确认，没收到就每3s重传一次。</li></ul></li><li><p>状态刷新：</p><ul><li><p>离组播源最近的第一条路由器会以每60s周期性发送刷新报文，并进行全网扩散。</p></li><li><p>可以用来刷新剪枝计时器，刷新报文置位为1时进行刷新，每三次报文置位为1，每180s刷新一次。</p></li></ul></li><li><p>断言：</p><ul><li>当从其下游接口发送一份组播数据，又从其下游接口收到该数据时，启动断言机制：</li><li>刚开始设备都认为自己的winner，并发送assert报文，里面携带了到达组播源的协议优先级和开销，通过对比来选出winner，先比较协议优先级，比小优先，相等就比开销，越小越优。再次相等就比较数据的源地址和自己接口的ip地址，比大优先，</li><li>==优胜者为winner，失败者为loser，winner之能有一个，loser可以有多个。==</li><li>成为loser的设备后，会自动剪除自己的下游接口，当下游接口列表为空时，发起剪枝，winner也会收到这个剪枝报文，同时开启断言计时器180s。在超时之前，接口一直处于剪枝状态。</li><li><p>==winner会周期性的向下游接口发送状态刷新报文，用来给loser刷新断言计时器。==</p></li><li><p>winner从下游接口收到剪枝报文，启动剪枝延时计时器，等待join报文的到来。否决剪枝行为。</p></li><li><p>关于断言场景下网络拓扑变化时，组播路径的切换：</p><ul><li>winner的上游接口中断：会从下游接口发送最差的assert报文来通知其他的loser。</li><li>最差的assert报文：协议优先级无限大，开销无限大。</li><li>winner的下游接口中断：此时无法从下游接口发送assert cancel报文，那么loser路由器只有等待与winner邻居失效后（默认105s），才会知道winner挂掉。</li></ul></li></ul></li></ul><h3 id="PIM-DM-报文："><a href="#PIM-DM-报文：" class="headerlink" title="PIM DM 报文："></a>PIM DM 报文：</h3><hr><table><thead><tr><th style="text-align:center">报文类型</th><th style="text-align:center">类型ID</th><th style="text-align:center">报文作用</th></tr></thead><tbody><tr><td style="text-align:center">hello</td><td style="text-align:center">0</td><td style="text-align:center">发现，协商参数。维护邻居关系</td></tr><tr><td style="text-align:center">jion/prune</td><td style="text-align:center">3</td><td style="text-align:center">加入/剪枝，J置位为1，表明为jion报文，p置位为1，表明为prune报文</td></tr><tr><td style="text-align:center">assert</td><td style="text-align:center">5</td><td style="text-align:center">断言</td></tr><tr><td style="text-align:center">graft</td><td style="text-align:center">6</td><td style="text-align:center">剪枝</td></tr><tr><td style="text-align:center">graft ack</td><td style="text-align:center">7</td><td style="text-align:center">剪枝确认</td></tr><tr><td style="text-align:center">state-refresh</td><td style="text-align:center">9</td><td style="text-align:center">状态刷新</td></tr></tbody></table>]]></content>
    
    <summary type="html">
    
      
      
        &lt;h1 id=&quot;PIM路由协议基础：&quot;&gt;&lt;a href=&quot;#PIM路由协议基础：&quot; class=&quot;headerlink&quot; title=&quot;PIM路由协议基础：&quot;&gt;&lt;/a&gt;PIM路由协议基础：&lt;/h1&gt;&lt;h3 id=&quot;PIM-DM的工作机制：&quot;&gt;&lt;a href=&quot;#PIM-DM的工作
      
    
    </summary>
    
      <category term="HCIP-R&amp;S 笔记" scheme="http://yoursite.com/categories/HCIP-R-S-%E7%AC%94%E8%AE%B0/"/>
    
    
      <category term="HCIP" scheme="http://yoursite.com/tags/HCIP/"/>
    
      <category term="组播" scheme="http://yoursite.com/tags/%E7%BB%84%E6%92%AD/"/>
    
  </entry>
  
  <entry>
    <title>PIM-SM路由协议基础</title>
    <link href="http://yoursite.com/2019/05/10/Pim-SM/"/>
    <id>http://yoursite.com/2019/05/10/Pim-SM/</id>
    <published>2019-05-10T04:12:57.000Z</published>
    <updated>2019-05-10T16:55:49.790Z</updated>
    
    <content type="html"><![CDATA[<h1 id="PIM-SM路由协议基础："><a href="#PIM-SM路由协议基础：" class="headerlink" title="PIM SM路由协议基础："></a>PIM SM路由协议基础：</h1><h3 id="PIM-SM基本原理："><a href="#PIM-SM基本原理：" class="headerlink" title="PIM SM基本原理："></a>PIM SM基本原理：</h3><ul><li>PIM-SM使用拉的模式转发组播报文，类似于按需使用的方法，一般应用于组播组成员多，相对稀疏，规模较大的网络，<h3 id="PIM-SM的工作机制："><a href="#PIM-SM的工作机制：" class="headerlink" title="PIM SM的工作机制："></a>PIM SM的工作机制：</h3></li></ul><h4 id="RP的发现："><a href="#RP的发现：" class="headerlink" title="RP的发现："></a>RP的发现：</h4><ul><li>在网络中维护一台RP,所有的pim路由器都知道RP的位置，RP负责接受组播数据，并向组播接受者进行转发，RP跟组播源构建一颗SPT树，RP跟组播接受者构建一颗RPT树。</li></ul><h4 id="RPT的构建："><a href="#RPT的构建：" class="headerlink" title="RPT的构建："></a>RPT的构建：</h4><ul><li>当网络中出现组成员，用户通过IGMP加入某组播组，然后由最后一跳路由器（成员端DR）向RP发送（<em> G）表项的join报文，并逐跳在pim路由器上建立（</em> G）表项。</li><li>==成员端DR会每隔60S向上游pim路由器发送join报文，收到join报文后，重置接口计时器（210s），超时后就会将此接口从下游接口中移除==</li><li>==只要接受者存在，成员端DR会每隔60S向上游pim路由器发送join报文，用来刷新（*  G）条目。维护RPT树。==</li></ul><h4 id="组播源注册："><a href="#组播源注册：" class="headerlink" title="组播源注册："></a>组播源注册：</h4><ul><li>当网络中出现活跃的组播源，源端DR会将此组播数据封装在register报文中，以单播的形式发送给RP,</li></ul><h4 id="SPT的构建："><a href="#SPT的构建：" class="headerlink" title="SPT的构建："></a>SPT的构建：</h4><ul><li>RP收到此register报文后，就得知了组播源的地址，然后向组播源发送（S G）表项的join报文，然后在沿途的pim路由器上创建相应的（S G）表项，构建一颗SPT树，之后的组播数据就根据（S G）进行转发,</li><li>RP这时可以通过两个方向收到组播数据，一个是从SPT，另一个是根据单播注册隧道，这时就会由RP像源端DR发送register stop 报文，注册停止报文，DR收到之后，就会启动一个注册抑制计时器，60s，超时后，继续发送注册报文。</li><li>为了降低RP的系统开销，在注册抑制计时器超时前5s，会像RP发送probe（空注册报文）报文中仅含组播源和组播组的信息，不含组播数据。</li><li><p>==空注册报文的作用：向RP通告组播源处于活跃，通知RP发送注册停止报文刷新注册抑制计时器时间==</p><h4 id="断言机制："><a href="#断言机制：" class="headerlink" title="断言机制："></a>断言机制：</h4></li><li><p>因为SM是拉流量的，在MA网络中，拉之前就已经选举了DR,所以非DR不会响应这个MA网络中主机的加组请求，也就不会像上发送（* G）jion,不能在上游路由器上创建下游接口，因此一般情况下不会触发断言机制，除非特殊情况，不通过DR,直接发送给RP.</p></li></ul><hr><h3 id="BSR-自举协议："><a href="#BSR-自举协议：" class="headerlink" title="BSR-自举协议："></a>BSR-自举协议：</h3><h3 id="RP的发现：-1"><a href="#RP的发现：-1" class="headerlink" title="RP的发现："></a>RP的发现：</h3><ul><li><p>静态RP:</p><ul><li>在每一台路由器上进行静态部署</li></ul></li><li><p>动态RP/C-RP</p><ul><li>将多个pim路由器部署为C-RP,来动态选出RP,同时还需要配置C-BSR,选举出BSR,来收集所有C-RP的通告信息。</li></ul></li><li>C-BSR的竞选：<ul><li>开始，所有的C-BSR都认为自己的BSR,以组播地址224.0.0.13向全网发送bootstarp报文，TTL值为1。</li><li>bootstarp携带C-BSR优先级，地址，每一台pim路由器收到后，通过比较选出BSR</li><li>先比较优先级再比较地址。都比大。</li></ul></li><li>C-RP的竞选：<ul><li>所有的C-RP都会以单播的形式向BSR发送Advertisement报文，==60s一次。超时时间为150s==</li><li>Advertisement报文携带C-RP的服务的组地址范围，C-RP的地址，优先级。</li><li>BSR收到之后，会将所有C-RP发送过来的报文进行一个汇总，汇总成AS-set，并封装在boostarp报文中，进行全网发送。</li><li>pim路由器收到之后，使用相同的规则进行计算和比较，选出一个RP.<ol><li>C-RP服务的组地址范围，越精确越优，（掩码长者优先）</li><li>比较C-RP的优先级，比大</li><li>将组地址、C-RP的地址、BSR的hash掩码长度（默认为30），进行hash运算，进行比较</li><li>比较C-RP的地址。比大</li></ol></li><li>比较出RP后，将组播组和RP的对应关系保存下来，指导后续的建树过程。</li></ul></li><li>RFP校验：<ul><li>BSR发送bootstarp报文，要进行RPF检验。<ol><li>接受组播数据的入接口是到达组播源的出接口</li><li>接受的组播数据源地址是到达组播源的下一跳。</li></ol></li><li>满足两个要求后，才可发送bootstarp报文。</li><li>因为bootstarp报文的ttl值为1，所以路由器转发时，源地址逐跳封装。</li></ul></li></ul><h3 id="RPT-SPT树的切换："><a href="#RPT-SPT树的切换：" class="headerlink" title="RPT/SPT树的切换："></a>RPT/SPT树的切换：</h3><ul><li><p>STP切换机制：成员端DR周期性的检测组播报文的转发速率，一旦发现（S G）报文的转发熟虑超过阈值，则触发SPT切换。</p><ol><li>组成员端DR逐跳向远端DR逐跳发送（S G）join报文，并沿途创建（S G）表项，建立源端DR到成员端DR的SPT树</li><li>SPT树建立后，成员端DR会沿着RPT树逐跳向RP发送剪枝报文，删除（* G）表项中相应的下游接口，之后再不必向下转发数据。</li><li>如果SPT不经过RP,那么RP会继续逐跳向源端DR发送剪枝报文，删除（S G）表项中相应的下游接口，之后再不必向下转发数据。</li></ol><blockquote><p>缺省情况下，设备一般没有配置阈值，所以当成员端DR知道了组播源的地址时，就会触发SPT的切换。</p></blockquote></li></ul>]]></content>
    
    <summary type="html">
    
      
      
        &lt;h1 id=&quot;PIM-SM路由协议基础：&quot;&gt;&lt;a href=&quot;#PIM-SM路由协议基础：&quot; class=&quot;headerlink&quot; title=&quot;PIM SM路由协议基础：&quot;&gt;&lt;/a&gt;PIM SM路由协议基础：&lt;/h1&gt;&lt;h3 id=&quot;PIM-SM基本原理：&quot;&gt;&lt;a href=
      
    
    </summary>
    
      <category term="HCIP-R&amp;S 笔记" scheme="http://yoursite.com/categories/HCIP-R-S-%E7%AC%94%E8%AE%B0/"/>
    
    
      <category term="HCIP" scheme="http://yoursite.com/tags/HCIP/"/>
    
      <category term="组播" scheme="http://yoursite.com/tags/%E7%BB%84%E6%92%AD/"/>
    
  </entry>
  
  <entry>
    <title>Hello World</title>
    <link href="http://yoursite.com/2019/05/09/hello-world/"/>
    <id>http://yoursite.com/2019/05/09/hello-world/</id>
    <published>2019-05-09T08:37:03.758Z</published>
    <updated>2017-10-28T00:39:58.000Z</updated>
    
    <content type="html"><![CDATA[<p>Welcome to <a href="https://hexo.io/" target="_blank" rel="noopener">Hexo</a>! This is your very first post. Check <a href="https://hexo.io/docs/" target="_blank" rel="noopener">documentation</a> for more info. If you get any problems when using Hexo, you can find the answer in <a href="https://hexo.io/docs/troubleshooting.html" target="_blank" rel="noopener">troubleshooting</a> or you can ask me on <a href="https://github.com/hexojs/hexo/issues" target="_blank" rel="noopener">GitHub</a>.</p><h2 id="Quick-Start"><a href="#Quick-Start" class="headerlink" title="Quick Start"></a>Quick Start</h2><h3 id="Create-a-new-post"><a href="#Create-a-new-post" class="headerlink" title="Create a new post"></a>Create a new post</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ hexo new <span class="string">"My New Post"</span></span><br></pre></td></tr></table></figure><p>More info: <a href="https://hexo.io/docs/writing.html" target="_blank" rel="noopener">Writing</a></p><h3 id="Run-server"><a href="#Run-server" class="headerlink" title="Run server"></a>Run server</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ hexo server</span><br></pre></td></tr></table></figure><p>More info: <a href="https://hexo.io/docs/server.html" target="_blank" rel="noopener">Server</a></p><h3 id="Generate-static-files"><a href="#Generate-static-files" class="headerlink" title="Generate static files"></a>Generate static files</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ hexo generate</span><br></pre></td></tr></table></figure><p>More info: <a href="https://hexo.io/docs/generating.html" target="_blank" rel="noopener">Generating</a></p><h3 id="Deploy-to-remote-sites"><a href="#Deploy-to-remote-sites" class="headerlink" title="Deploy to remote sites"></a>Deploy to remote sites</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ hexo deploy</span><br></pre></td></tr></table></figure><p>More info: <a href="https://hexo.io/docs/deployment.html" target="_blank" rel="noopener">Deployment</a></p>]]></content>
    
    <summary type="html">
    
      
      
        &lt;p&gt;Welcome to &lt;a href=&quot;https://hexo.io/&quot; target=&quot;_blank&quot; rel=&quot;noopener&quot;&gt;Hexo&lt;/a&gt;! This is your very first post. Check &lt;a href=&quot;https://hexo.
      
    
    </summary>
    
    
  </entry>
  
</feed>
